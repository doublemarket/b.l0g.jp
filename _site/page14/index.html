<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      渋谷ではたらくインフラエンジニアのブログ &middot; 
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/dev/finding-bottleneck-with-sar2/">
        sarコマンドでシステムのボトルネックを探る(2)
      </a>
    </h1>

    <time datetime="2011-02-21T14:07:48-08:00" class="post-date">21 Feb 2011</time>

    <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/dev/finding-bottleneck-with-sar2/" class="hatena-bookmark-button" data-hatena-bookmark-title="sarコマンドでシステムのボトルネックを探る(2)" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/dev/finding-bottleneck-with-sar2/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/dev/finding-bottleneck-with-sar2/" data-text="sarコマンドでシステムのボトルネックを探る(2)" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/dev/finding-bottleneck-with-sar2/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p>CPUの処理の状況を調べるためには、sar (sar -u)が有効であることを<a href="http://b.l0g.jp/dev/finding-bottleneck-with-sar1/" target="_blank">前のエントリ</a>で書いた。次はメモリの使用状況を調べてみる。まず見てみるのは、メモリとスワップの使用状況を示す sar -r の結果である。</p>

<p>[text]</p>

<p>[doublemarket@hoge ~]$ sar -r</p>

<p>Linux 2.6.18-194.8.1.el5 (hoge) 2011年02月15日</p>

<p>00時00分01秒 kbmemfree kbmemused %memused kbbuffers kbcached kbswpfree kbswpused %swpused kbswpcad</p>

<p>00時10分01秒 12964 497568 97.46 30880 107440 1984336 63940 3.12 16392</p>

<p>00時20分01秒 13064 497468 97.44 30972 107376 1984336 63940 3.12 16392</p>

<p>00時30分01秒 12692 497840 97.51 31092 107236 1984336 63940 3.12 16392</p>

<p>:</p>

<p>:</p>

<p>20時20分01秒 43756 466776 91.43 45624 139552 1984336 63940 3.12 16288</p>

<p>20時30分01秒 27008 483524 94.71 46420 147608 1984336 63940 3.12 16288</p>

<p>20時40分01秒 22664 487868 95.56 46840 148920 1984336 63940 3.12 16288</p>

<p>20時50分01秒 22300 488232 95.63 47192 148968 1984336 63940 3.12 16288</p>

<p>平均値: 84267 426265 83.49 32592 129944 1984336 63940 3.12 16300</p>

<p>[/text]</p>

<p>それぞれの列の意味は以下の通り。</p>

<dt style="padding-left: 30px;">
  <strong>kbmemfree</strong>
</dt>

<dd style="padding-left: 60px;">
  物理メモリの未使用KB。
</dd>

<dt style="padding-left: 30px;">
  <strong>kbmemused</strong>
</dt>

<dd style="padding-left: 60px;">
  物理メモリの使用済みKB。
</dd>

<dt style="padding-left: 30px;">
  <strong>%memused</strong>
</dt>

<dd style="padding-left: 60px;">
  物理メモリの使用率。Linuxでは、使用されていないメモリ領域をファイルシステムキャッシュ領域として使用するので、通常はほとんどfree部分はないものと考えてよい。従って、常に90数%といった高い使用率になる。実際にアプリケーションの動作に使われているメモリの量は、下の指標を確認する必要がある。
</dd>

<dt style="padding-left: 30px;">
  <strong>kbbuffers</strong>
</dt>

<dd style="padding-left: 60px;">
  カーネルがバッファ領域として使用しているメモリ量のKB。
</dd>

<dt style="padding-left: 30px;">
  <strong>kbcached</strong>
</dt>

<dd style="padding-left: 60px;">
  カーネルがキャッシュとして使用しているメモリ量のKB。kbmemusedからkbbufferesとkbcachedを引いた値が、実際にアプリケーションに割り当てられているメモリ量ということになる。逆に言えば、kbbufferesとkbcachedの容量が、kbmemusedの大部分を占めているようなら、アプリケーションにとってメモリ不足とは言えないということになる。
</dd>

<dt style="padding-left: 30px;">
  <strong>kbswpfree</strong>
</dt>

<dd style="padding-left: 60px;">
  スワップ領域の未使用量KB。
</dd>

<dt style="padding-left: 30px;">
  <strong>kbswpused</strong>
</dt>

<dd style="padding-left: 60px;">
  スワップ領域の使用済みKB。
</dd>

<dt style="padding-left: 30px;">
  <strong>%swpused</strong>
</dt>

<dd style="padding-left: 60px;">
  スワップ領域の使用量。通常ほとんど0だが、物理メモリが不足してくると使用率が上がってくる。数%であれば実質的にシステムの動作には影響がない場合が多いが、あまり多いようだと、スワップ領域へのアクセスが頻発している可能性もあり、システム全体のスループットを落とすことがある。%swpusedが大きく、かつsar -uのiowaitの値も大きい場合、ほぼ間違いなくスワップ領域へのアクセスでスローダウンしているので、物理メモリの増設などのメモリ不足解消策を取る必要がある。
</dd>

<dt style="padding-left: 30px;">
  <strong>kbswpcad</strong>
</dt>

<dd style="padding-left: 60px;">
  何の指標かよく分からなかったが、manページによると、一旦スワップ領域へ飛ばされたものの(スワップアウト)、スワップ領域からメモリに戻され(スワップイン)、かつまだスワップ領域にデータが残っている、というデータの量とのこと。
</dd>

<p>各列の値の傾向を見ると、上記のようにメモリ不足なのかどうかの手がかりが得られる。その他に詳しい情報を見たいときは、以下のオプションも用意されている。</p>

<dt style="padding-left: 30px;">
  <strong>sar -R</strong>
</dt>

<dd style="padding-left: 60px;">
  メモリ上のページの使用状況。
</dd>

<dt style="padding-left: 30px;">
  <strong>sar -W</strong>
</dt>

<dd style="padding-left: 60px;">
  スワップの発生状況。ページイン(スワップ領域から物理メモリへのページの移動)とページアウト(物理メモリからスワップ領域へのページの移動)がどの程度発生したのかを確認できる。
</dd>

<dt style="padding-left: 30px;">
  <strong>sar -B</strong>
</dt>

<dd style="padding-left: 60px;">
  ページングの状況。ページイン・ページアウトされたデータ容量、ページフォルトの回数、メジャーなページフォルトの回数をそれぞれ確認できる。
</dd>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/dev/finding-bottleneck-with-sar1/">
        sarコマンドでシステムのボトルネックを探る(1)
      </a>
    </h1>

    <time datetime="2011-02-17T13:59:39-08:00" class="post-date">17 Feb 2011</time>

    <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/dev/finding-bottleneck-with-sar1/" class="hatena-bookmark-button" data-hatena-bookmark-title="sarコマンドでシステムのボトルネックを探る(1)" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/dev/finding-bottleneck-with-sar1/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/dev/finding-bottleneck-with-sar1/" data-text="sarコマンドでシステムのボトルネックを探る(1)" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/dev/finding-bottleneck-with-sar1/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p><a href="http://b.l0g.jp/dev/top-loadaverag/" target="_blank">前回のエントリ</a>では、システムのレスポンスが悪化している場合、まずとっかかりとしてtopコマンドを実行し、ロードアベレージを確認する方法を書いた。さらに踏み込んで、何が負荷の原因なのかを探るために、sarコマンドを使う方法について書く。</p>

<p>sarコマンドをオプションをつけずに実行すると、以下のような出力が得られる。ファイルを指定しないと、コマンドを実行した当日の0:00から直前までの10分おきの情報が表示される。過去の情報は/var/log/saディレクトリ以下に保存されており、「sar -f sa07」などと指定すると、そのファイルに保存された情報が閲覧できる。saの後の数字は日付を表している。</p>

<p>sarを実行してもコマンドが見つからない場合、sysstatパッケージがインストールされていないので、インストールすべし。</p>

<p>[text]</p>

<p>[doublemarket@hoge ~]$ sar</p>

<p>Linux 2.6.18-194.8.1.el5 (hoge) 2011年02月15日</p>

<p>00時00分01秒 CPU %user %nice %system %iowait %steal %idle</p>

<p>00時10分01秒 all 0.05 0.00 0.08 0.02 0.00 99.85</p>

<p>00時20分01秒 all 0.03 0.00 0.08 0.02 0.00 99.88</p>

<p>00時30分01秒 all 0.07 0.00 0.11 0.02 0.00 99.79</p>

<p>:</p>

<p>:</p>

<p>20時00分01秒 all 0.03 0.00 0.06 0.00 0.00 99.90</p>

<p>20時10分01秒 all 0.06 0.00 0.11 0.03 0.00 99.80</p>

<p>20時20分01秒 all 0.16 0.00 0.14 0.03 0.00 99.67</p>

<p>20時30分01秒 all 1.11 0.00 0.27 0.12 0.00 98.50</p>

<p>20時40分01秒 all 0.08 0.00 0.12 0.05 0.00 99.76</p>

<p>平均値: all 0.08 0.00 0.10 0.09 0.00 99.73</p>

<p>[/text]</p>

<p>ここで得られる結果は、sar -uと同じものである。それぞれの列の意味は以下の通り。</p>

<dt style="padding-left: 30px;">
  <strong>user</strong>
</dt>

<dd style="padding-left: 60px;">
  ユーザプログラムの実行に使用されたCPUリソースの割合
</dd>

<dt style="padding-left: 30px;">
  <strong>nice</strong>
</dt>

<dd style="padding-left: 60px;">
  niceによる優先度を処理するために使用されたCPUリソースの割合
</dd>

<dt style="padding-left: 30px;">
  <strong>system</strong>
</dt>

<dd style="padding-left: 60px;">
  カーネルが使用したCPUリソースの割合
</dd>

<dt style="padding-left: 30px;">
  <strong>iowait</strong>
</dt>

<dd style="padding-left: 60px;">
  I/O待ちの割合
</dd>

<dt style="padding-left: 30px;">
  <strong>idle</strong>
</dt>

<dd style="padding-left: 60px;">
  I/O待ち以外でCPUが待ち状態だった割合(何もしていない時間)
</dd>

<p>なお、マルチCPUの環境の場合ここに表示されているのは、全CPUの合算使用率になっている。それぞれのCPUの使用率を確認したい場合、「sar -P ALL」を実行する。意外と処理が特定のCPUに偏っていたりするので、こちらも確認してみた方がよい。</p>

<p>→ sarコマンドの実行結果からシステムの負荷状況に関して、以下の傾向がつかめる。</p>

<dt style="padding-left: 30px;">
  <strong>userの値だけが高い(他の値は低いまま)</strong>
</dt>

<dd style="padding-left: 60px;">
  CPUリソースを必要とするアプリケーションが動作している。<br /> topやps auwxなどのコマンドでプロセスごとのCPU使用率を調べ、無限ループなどの不具合によるCPU使用率の上昇でないかなど、異常を確認。単に処理が重くなっているだけなら、スケールアップ(CPUを高速化)、スケールアウト(マシンを増設)を検討する。
</dd>

<dt style="padding-left: 30px;">
  <strong>iowaitの値が高い</strong>
</dt>

<dd style="padding-left: 60px;">
  そのマシンに求められる処理に対して、ハードディスクの速度が追いついていない。アプリケーションやミドルウェア(特にデータベースなど)のキャッシュの仕組みを見直したり、読み書きに使う物理的なディスクを分散させるなどして、なるべくディスクの読み書きが発生しない方法を考える。それでも高いままなら、より高速なディスクを使うしかない。なおたいていの場合は<br /> ・アプリケーション自体がディスクにアクセスする速度が遅い<br /> ・メモリが不足していてスワップ領域(つまりディスク)へのアクセスが頻発していて遅い<br /> の2つに問題を分けることができる。このうちのどちらかという判断は、sar -rの結果などを見る必要がある。
</dd>

<dt style="padding-left: 30px;">
  <strong>systemの値が高い</strong>
</dt>

<dd style="padding-left: 60px;">
  仕組み的にいえば、コンテキストスイッチがたくさん発生していると値が上がるはずなので、必要以上にたくさんのプログラムを並列に処理しすぎていると、この値が異常に上がるということになるが、よく分からない。
</dd>

<p>sarコマンドには、メモリやディスク、ネットワークなどに関する情報が得られるよう、他にも色々なオプションがある。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/dev/top-loadaverag/">
        topコマンドでロードアベレージを見る
      </a>
    </h1>

    <time datetime="2011-02-15T15:58:48-08:00" class="post-date">15 Feb 2011</time>

    <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/dev/top-loadaverag/" class="hatena-bookmark-button" data-hatena-bookmark-title="topコマンドでロードアベレージを見る" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/dev/top-loadaverag/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/dev/top-loadaverag/" data-text="topコマンドでロードアベレージを見る" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/dev/top-loadaverag/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p>Linuxにおいて、システムの全体的な負荷状況を知りたい時、リアルタイムの状況を知るにはtopコマンド、ある程度の期間に渡る傾向をつかむにはsar(sysstat)の結果を確認するのが一般的だろう。</p>

<p>そのサーバ上で動作するアプリケーションの動作が遅いなどといったパフォーマンス劣化がある時、まず最初に見るべきがロードアベレージの値。これは「CPUの処理を待っているタスクの数」であり、ほとんど何も処理を行っていない時には0になる。</p>

<p>topコマンドの表示内容</p>

<p>[text]</p>

<p>top – 16:04:44 up 15 days, 21:40, 2 users, load average: 0.00, 0.00, 0.00</p>

<p>Tasks: 108 total, 2 running, 105 sleeping, 0 stopped, 1 zombie</p>

<p>Cpu(s): 0.0% us, 0.0% sy, 0.0% ni, 100.0% id, 0.0% wa, 0.0% hi, 0.0% si</p>

<p>Mem: 8113608k total, 8082584k used, 31024k free, 69652k buffers</p>

<p>Swap: 8385920k total, 352k used, 8385568k free, 6008888k cached</p>

<p>PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND</p>

<p>1 root 16 0 1848 552 472 S 0.0 0.0 0:01.32 init</p>

<p>2 root RT 0 0 0 0 S 0.0 0.0 0:17.52 migration/0</p>

<p>3 root 34 19 0 0 0 S 0.0 0.0 0:00.40 ksoftirqd/0</p>

<p>4 root RT 0 0 0 0 S 0.0 0.0 0:15.31 migration/1</p>

<p>5 root 34 19 0 0 0 S 0.0 0.0 0:00.32 ksoftirqd/1</p>

<p>6 root RT 0 0 0 0 S 0.0 0.0 0:11.21 migration/2</p>

<p>7 root 34 19 0 0 0 S 0.0 0.0 0:00.17 ksoftirqd/2</p>

<p>8 root RT 0 0 0 0 S 0.0 0.0 0:15.26 migration/3</p>

<p>9 root 34 19 0 0 0 S 0.0 0.0 0:00.25 ksoftirqd/3</p>

<p>10 root 5 -10 0 0 0 S 0.0 0.0 0:00.00 events/0</p>

<p>11 root 5 -10 0 0 0 S 0.0 0.0 0:00.00 events/1</p>

<p>12 root 5 -10 0 0 0 S 0.0 0.0 0:00.00 events/2</p>

<p>13 root 5 -10 0 0 0 S 0.0 0.0 0:00.00 events/3</p>

<p>14 root 7 -10 0 0 0 S 0.0 0.0 0:00.00 khelper</p>

<p>15 root 15 -10 0 0 0 S 0.0 0.0 0:00.00 kacpid</p>

<p>95 root 5 -10 0 0 0 S 0.0 0.0 0:00.00 kblockd/0</p>

<p>96 root 5 -10 0 0 0 S 0.0 0.0 0:00.00 kblockd/1</p>

<p>[/text]</p>

<p>1行目の右端に表示されているのがロードアベレージの値。前述の通りCPUの処理を待っているタスクの数がロードアベレージなので、値が大きければ大きいほどCPUの処理を待っているタスクが多いということになり、それだけサーバのレスポンスが落ちることになる。ただし、単に計算を待っているだけではなく、IOの処理を待っている場合もこの値が大きくなるので、ロードアベレージが大きいことが即CPUが遅いことになるわけではない。CPUそのもの、メモリ、ディスク、それ以外、の何が原因で遅いか調査する必要がある。</p>

<p>なお、topでのロードアベレージの表示は、左から、1分、5分、15分間の平均値になっている。つまり、左の方が値が大きければ、直近の数分間で急に負荷が上がっていることを表す。</p>

<p>言わずもがなだが下半分には、CPUの使用率順に並んだプロセス一覧が表示されるので、ここからCPU負荷が高かったりメモリの使用量が多いアプリケーションが何なのかは大体つかめる。topからなんとなくのあたりをつけたあと、何がボトルネックになっているかを探すには、sarコマンドで過去のパフォーマンスデータを確認していく。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page15">Older</a>
  
  
    <a class="pagination-item newer" href="/page13">Newer</a>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T10:52:50-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
