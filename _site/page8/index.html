<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      渋谷ではたらくインフラエンジニアのブログ &middot; 
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/mysql/use-cacti-to-monitor-mysql-2/">
        MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)
      </a>
    </h1>

    <time datetime="2012-05-28T05:00:12-07:00" class="post-date">28 May 2012</time>

    <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/" class="hatena-bookmark-button" data-hatena-bookmark-title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/" data-text="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p><a title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)" href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" target="_blank">前回のエントリ</a>ではMySQLのサーバを監視できるように、CactiをインストールしてPercona Monitoring Pluginsのテンプレートを読み込んだところまで書いた。今回は、監視対象となるMySQLサーバを設定して、リソース監視を行うまでを書いてみる。なお、プロンプトがtargetとなって いるものが監視対象への設定で、serverとなっているものが監視サーバへの設定を意味している。</p>

<h2 id="snmpubuntu-server">SNMPの設定(Ubuntu serverの場合)</h2>

<p>Ubuntuでは標準ではSNMPがインストールされていないので、まずはインストールする。</p>

<p>[bash]</p>

<p>target$ sudo apt-get install snmp snmpd</p>

<p>[/bash]</p>

<p>/etc/snmp/snmpd.confにsnmpdのデフォルト設定ファイルが置かれるので、監視サーバから情報を取 得できるように編集する。</p>

<p>まず、監視サーバからの読み出し許可設定を追記。SNMPコミュニティ名は「public」がデフォルト設定としては一般的だが、適宜設定。</p>

<p>[text]</p>

<p># 監視対象で設定</p>

<p>rocommunity SNMPコミュニティ名 監視サーバのIP # 追記</p>

<p>view all all # 追記</p>

<p>[/text]</p>

<p>全インタフェースからの接続を許可するよう設定。</p>

<p>[text]</p>

<p># 監視対象で設定</p>

<p>#agentAddress udp:127.0.0.1:161 # この行はコメントアウト</p>

<p>agentAddress udp:161 # 追記</p>

<p>[/text]</p>

<p>snmpdを再起動した後、監視サーバから以下のコマンドを実行して応答があればSNMPの設定は完了。</p>

<p>[bash]</p>

<p>target$ sudo /etc/init.d/snmpd restart</p>

<p>[/bash]</p>

<p>[bash]</p>

<p>server$ snmpwalk -v1 -c public 監視対象IPアドレス .1.3.6.1.2.1.1.1.0</p>

<p>SNMPv2-MIB::sysDescr.0 = STRING: Linux ubuntu1110s-01 2.6.38-8-server #42-Ubuntu SMP Mon Apr 11 03:49:04 UTC 2011 x86_64</p>

<p>↑ 応答の例</p>

<p>[/bash]</p>

<h2 id="snmpcentos">SNMPの設定(CentOSの場合)</h2>

<p>通常、SNMPはデフォルトでインストールされるので、設定ファイルを編集して監視サーバから接続できるようにする。基本的にはUbuntuと同じ設定にすればよい。</p>

<p>[bash]</p>

<p># 監視対象で設定</p>

<p>rocommunity SNMPコミュニティ名 監視サーバのIP # 追記</p>

<p>view all all # 追記</p>

<p>[/bash]</p>

<p>snmpdが自動起動するように設定し(どうやら初期設定では自動起動しないようになっている模様)、snmpdを再起動して設定を反映させる。</p>

<p>[bash]</p>

<p>target$ sudo chkconfig snmpd on</p>

<p>target$ sudo /etc/init.d/snmpd start</p>

<p>[/bash]</p>

<p>[bash]</p>

<p>server$ snmpwalk -v1 -c public 監視対象IPアドレス .1.3.6.1.2.1.1.1.0</p>

<p>SNMPv2-MIB::sysDescr.0 = STRING: Linux centos62-64-01 2.6.32-220.el6.x86_64 #1 SMP Tue Dec 6 19:48:22 GMT 2011 x86_64</p>

<p>↑ 応答の例</p>

<p>[/bash]</p>

<h2 id="cactimysql">Cacti監視のためのMySQL設定</h2>

<p>Percona Monitoring Plugins for Cactiは、監視対象のMySQLにログインして、色々な種類のshowコ マンドを実行して得られた結果をグラフにするので、監視対象のMySQLにユーザを追加する必要があ る。ここで指定するユーザ名とパスワードは、<a title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)" href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" target="_blank">前回のエントリ</a>でss_get_mysql_stats.phpファイルに書いた、 $mysql_user と $mysql_pass と一致させること。</p>

<p>[bash]</p>

<p>target$ mysql -uroot</p>

<p>mysql-target&gt; grant process, super on *.* to ユーザ名@監視サーバ identified by ‘パスワ ード’;</p>

<p>mysql-target&gt; flush privileges;</p>

<p>[/bash]</p>

<h2 id="cacti">Cactiからの監視設定</h2>

<p>監視サーバのCacti管理画面で、画像のように Create → New Graphs → Create New Host とたどり、監視対象デバイス作成画面を開く。</p>

<p><a href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/attachment/05/" rel="attachment wp-att-1215"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/05.png" title="デバイ ス作成画面" width="586" height="372" class="alignnone size-full wp-image-1215" style="border: 0px;" /></a></p>

<p>以下のように入力し、「Create」ボタンを押す。</p>

<table border="" align="center">
  <tr>
    <td>
      Description
    </td>
    
    <td>
      監視対象ホスト名など、一意に監視対象がわかる記述
    </td>
  </tr>
  
  <tr>
    <td>
      Hostname
    </td>
    
    <td>
      監視対象IPアドレスあるいは名前解決できる場合ホスト名
    </td>
  </tr>
  
  <tr>
    <td>
      Host Template
    </td>
    
    <td>
      Percona MySQL Server HT
    </td>
  </tr>
  
  <tr>
    <td>
      SNMP Community, SNMP Port
    </td>
    
    <td>
      SNMPコミュニティ名にpublic以外を指定した場合は適宜設定
    </td>
  </tr>
</table>

<p>Createボタンを押した後、画面下側に関連づけられたグラフが一覧表示される。Percona Monitoring Pluginsで取得できる情報は、あくまでMySQLのものだけで、実際にはLinuxの情報も取得しておく必要があるので、Host Templateに「Linux Server Default Set」を選んでもう一度Createボタンを押 して、最低限のOS関連情報も取れるようにしておこう。</p>

<p>ここまで時点では、画面下側に表示されたグラフテンプレートがホストにひもづけられただけで、実際にグラフの作成は開始されていない。右上の「Create New Graphs」をクリックし、画像のように 作成したいグラフを選択して、「Create」を押すと、対応するグラフの情報取得が始まる。</p>

<p><a href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/attachment/06/" rel="attachment wp-att-1237"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/06.png" title="グラフ 作成" width="592" height="287" class="alignnone size-full wp-image-1237" style="border: 0px;" /></a></p>

<p><a href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/attachment/07/" rel="attachment wp-att-1239"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/07.png" title="グラフ 作成" width="592" height="470" class="alignnone size-full wp-image-1239" style="border: 0px;" /></a></p>

<h2 id="section">ツリーへのホスト追加</h2>

<p>この状態では左上の「graphs」タブに移動しても左側のツリーには追加したサーバは表示されていないだろう。もう一度「console」タブに戻り、 Management → Devices から、監視対象デバイスの一覧を開き、今追加したサーバにチェックを付ける。右下の「Choose an action」から、「Add graph to tree」を選択してGoボタンを押し、ツリーに追加すると、めでたく graph タブのツリーにホストが現れ、グラフが表示される。</p>

<p><a href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/attachment/08/" rel="attachment wp-att-1240"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/08.png" title="ツリー に追加" width="592" height="353" class="alignnone size-full wp-image-1240" style="border: 0px;" /></a></p>

<p>画像がリンク切れの場合、まだグラフを描画できる情報が集まっていないので、少し(5分おきの情報収集がデフォルトなので、2回分10分以上)待ってもう一度確認しよう。画像は表示されたのに、いくら待ってもグラフが表示されない場合は、監視対象から情報が取得できていない可能性があるので、SNMPの設定やMySQLの設定(特にユーザ関連)を見直すべし。</p>

<p>グラフをどう読み取っていくかについては、以下の記事が参考になる。記事中には「better-cacti-template」とあるが、これはPercona Monitoring Plugin for Cactiの前身となるものなので、ほぼ同じと考えてよい。</p>

<p><a title="これだけ見れば大丈夫！ーMySQLパフォーマンス監視のツボ（クエリ編）" href="http://www.infiniteloop.co.jp/blog/2012/03/mysql-tuning-cacti-query/" target="_blank">これだけ見 れば大丈夫！ーMySQLパフォーマンス監視のツボ（クエリ編）</a></p>

<p>今回はPercona Monitoring Plugin for CactiのMySQLに関する部分だけを紹介したが、ApacheやMemcached、nginx、redisなどの情報グラフ化もできるので、お試しあれ。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/mysql/install-cacti-to-monitor-mysql-1/">
        MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)
      </a>
    </h1>

    <time datetime="2012-05-17T13:01:24-07:00" class="post-date">17 May 2012</time>

    <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" class="hatena-bookmark-button" data-hatena-bookmark-title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" data-text="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p>MySQLをリソース監視する仕組みにはいくつかあるが、対象のMySQLサーバが5台以上ある場合はCactiがおすすめ。導入のしやすさだけでMuninを選ぶ人が多い気がするが、その選択基準は間違っている！</p>

<p><a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/attachment/cacti-211916/" rel="attachment wp-att-1173"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/Cacti-211916.png" title="Cactiグラフの例" width="223" height="256" class="alignleft  wp-image-1173" style="margin-top: 0px; margin-bottom: 0px; margin-left: 10px; margin-right: 40px; border-style: initial; border-color: initial; border-image: initial; border-width: 0px;" /></a></p>

<p> </p>

<p><strong>Cactiのいいとこわるいとこ</strong></p>

<ul>
  <li>多数のグラフを見やすく並べられる</li>
  <li>muninと比べて多数のサーバから軽快に情報を収集・表示できる</li>
  <li>監視対象には、MySQLのユーザを追加するだけでかなりの項目数を監視できる</li>
  <li>データの保存にデータベースが必須だったりしてセットアップがやや面倒</li>
  <li>慣れるまで監視プラグインを書くのに手間取る</li>
</ul>

<p><strong>Muninのいいとこわるいとこ</strong></p>

<ul>
  <li>監視プラグインを書くのが簡単</li>
  <li>監視サーバにデータベースなどが必要なく、セットアップが簡単</li>
  <li>グラフの並び方などが固定で、比較などがしにくい</li>
  <li>監視対象にプラグインを入れなければならず、台数が多いとそれだけ手間が増える</li>
  <li>監視対象が増えると監視サーバの負荷が急激にあがるので、あまり多数のサーバは監視できない</li>
</ul>

<p>そんなわけで、CentOS 6.2上にCactiの監視サーバをセットアップし、<a title="Percona Monitoring Plugin" href="http://www.percona.com/software/percona-monitoring-plugins/" target="_blank">Percona Monitoring Plugins for Cacti</a>を使ってMySQLサーバ(CentOSまたはUbuntu)のリソース監視を始めるまでの手順。その1は監視サーバのセットアップ編。</p>

<h2 id="rpmforge">RPMforgeのリポジトリ追加</h2>

<p>RPMforgeリポジトリには最新のCactiが含まれているため、これを導入する。</p>

<p>[bash]</p>

<p>$ wget http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm</p>

<p>$ sudo rpm -ihv rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm</p>

<p>$ sudo yum -y update rpmforge-release</p>

<p>[/bash]</p>

<p>/etc/yum.repos.d/rpmforge.repo ファイルをエディタで開き、 enabled = 0 にする。これで、オプションを付けないとRPMforgeはリポジトリとして有効にならないようになる。</p>

<h2 id="cacti">Cactiのインストール</h2>

<p>Cactiと、あわせて必要なnet-snmpやhttpd、MySQLなどをインストール。</p>

<p>[bash]</p>

<p>$ sudo yum install –enablerepo=rpmforge cacti net-snmp-utils mysql-server</p>

<p>[/bash]</p>

<p>指定したもの以外に、依存関係上httpd, mysql, perl, php, rrdtoolなどもインストールされる。</p>

<h2 id="mysql">MySQLの設定</h2>

<p>Cactiが取得した情報を格納するためのMySQLを設定する。ここでは最低限必要な設定だけを記述するが、CentOS 6.2のMySQLの/etc/my.cnfは非常にシンプルなので、必要に応じてパラメータを指定すること。</p>

<p>[mysqld]セクションに以下を追加</p>

<p>[text]</p>

<p>skip-character-set-client-handshake</p>

<p>character-set-server = utf8</p>

<p>collation-server = utf8_general_ci</p>

<p>init-connect = SET NAMES utf8</p>

<p>[/text]</p>

<p>(2012.05.29) default-character-setは不要とnippondanjiさんからはてブコメントで指摘をいただいたので削除。直々にご指摘とは恐縮です。</p>

<p>ここでMySQLを再起動する。</p>

<p>[bash]</p>

<p>$ sudo /etc/init.d/mysqld restart</p>

<p>[/bash]</p>

<p>statusコマンドで、charactersetがutf8であることを確認。</p>

<p>[sql]</p>

<p>mysql&gt; status;</p>

<p>(略)</p>

<p>Server characterset: utf8</p>

<p>Db characterset: utf8</p>

<p>Client characterset: utf8</p>

<p>Conn. characterset: utf8</p>

<p>(略)</p>

<p>[/sql]</p>

<p><a href="http://docs.cacti.net/manual:088:1_installation.1_install_unix.5_install_and_configure_cacti" target="_blank">Cactiのドキュメント</a>にしたがって、Cactiで使用するMySQLの設定を行う。</p>

<p>[sql]</p>

<p>$ mysqladmin –user=root create cacti</p>

<p>$ mysql cacti &lt; cacti.sql</p>

<p>$ mysql –user=root mysql</p>

<p>mysql&gt; grant all on cacti.* to ユーザ名@localhost identified by ‘パスワード’;</p>

<p>mysql&gt; flush privileges;</p>

<p>[/sql]</p>

<h2 id="apachephp">Apache/PHPの設定</h2>

<p>/var/www/cacti/include/config.php を上の項で作成したユーザに合わせて編集する。</p>

<p>[text]</p>

<p>$database_type = “mysql”;</p>

<p>$database_default = “cacti”;</p>

<p>$database_hostname = “localhost”; # DBサーバのホスト名</p>

<p>$database_username = “cactiuser”; # 上の項で作成したユーザ</p>

<p>$database_password = “cactipassword”; # 上の項で設定したパスワード</p>

<p>[/text]</p>

<p>/etc/httpd/conf.d/cacti.php が存在することを確認する。他のホストからCactiにアクセスする際は、以下の行を追加してhttpdを再起動する。</p>

<p>[text]</p>

<p>allow from 127.0.0.1</p>

<p>allow from IPアドレス # 追記</p>

<p>[/text]</p>

<p><a href="http://docs.cacti.net/manual:088:1_installation.1_install_unix.1_configure_php" target="_blank">Cactiのドキュメント</a>を参考に、/etc/php.ini および /etc/php.d/*.ini の記述を確認。設定を変更したら、Apacheを再起動する。</p>

<p>[bash]</p>

<p>$ sudo /etc/init.d/httpd restart</p>

<p>[/bash]</p>

<h2 id="iptables">iptablesの設定</h2>

<p>CentOS 6.2ではデフォルトでpingやSSHしか応答できないようにされているようなので、/etc/sysconfig/iptables に以下を追加してhttpのアクセスが可能なようにする。</p>

<p>[text]</p>

<p>-A INPUT -m state –state NEW -m tcp -p tcp –dport 80 -j ACCEPT</p>

<p>[/text]</p>

<p>iptablesを再起動</p>

<p>[text]</p>

<p>$ sudo /etc/init.d/iptables restart</p>

<p>[/text]</p>

<h2 id="section">設定完了</h2>

<p>Cactiをインストールした際に /etc/cron.d/cacti が既に作成されているので、この時点で5分おきに情報収集が始まっている。</p>

<p>http://CactiサーバのIPアドレス/cacti を開くと、まずインストールの確認ウィザードが開始される。</p>

<p style="text-align: center;">
  <a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/attachment/03-2/" rel="attachment wp-att-1159"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/03.png" title="インストール確認ウィザード" width="305" height="244" class="size-full wp-image-1159 aligncenter" style="border-style: initial; border-color: initial; border-image: initial; border-width: 0px;" /></a>
</p>

<p>ここまでの設定を改めて確認されるだけなので、基本的にはNextを押していけばいい。各種ツールのパスを確認される画面が最後にあるが、ここでパスが見つからない場合は手動でパスを入力するか、不足しているツールをインストールして再度試すべし。</p>

<p>この後ログイン画面が表示され、ユーザ名 admin 、 パスワード admin でログイン可能で、すぐにパスワードの変更を促されるので画面の指示に従って変更する。</p>

<h2 id="percona-monitoring-plugin-for-cacti">Percona Monitoring Plugin for Cactiの導入</h2>

<p><a href="http://www.percona.com/downloads/percona-monitoring-plugins/" target="_blank">Percona</a>からPercona monitoring pluginsをダウンロードし、ファイルを展開する。</p>

<p>[bash]</p>

<p>$ tar zxvf percona-monitoring-plugins-1.0.0.tar.gz</p>

<p>$ cd percona-monitoring-plugins-1.0.0/cacti/scripts</p>

<p>$ sudo cp ss_get_by_ssh.php ss_get_mysql_stats.php /var/www/cacti/scripts/</p>

<p>[/bash]</p>

<p>監視対象のMySQLにログインする際のアカウント情報を ss_get_mysql_stats.php に書き込む。</p>

<p>[text]</p>

<p>$mysql_user = ‘cactiuser’; # 監視対象にログインする際のMySQLユーザ</p>

<p>$mysql_pass = ‘cactiuser’; # 監視対象にログインする際のパスワード</p>

<p>[/text]</p>

<p>Cacti管理画面からImport/Export → Import templatesを選択し、Import Template from Local Fileで以下を指定してImportボタンを押し、テンプレートファイルを読み込ませる。</p>

<p>[text]</p>

<p>percona-monitoring-plugins-1.0.0/cacti/templates/cacti_host_template_percona_mysql_server_ht_0.8.6i-sver1.0.0.xml</p>

<p>[/text]</p>

<p>成功すると、それぞれの監視項目に対応したテンプレートごとに[success]と表示される。</p>

<p style="text-align: center;">
  <a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/attachment/04-2/" rel="attachment wp-att-1160"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/04.png" title="テンプレート読み込み" width="360" height="393" class="size-full wp-image-1160 aligncenter" style="border-style: initial; border-color: initial; border-image: initial; border-width: 0px;" /></a>
</p>

<p>これでMySQLサーバを監視するための監視サーバの準備は完了。</p>

<p>(2012.05.28追記) 監視対象側の設定についても書いたので、続けてどうぞ。</p>

<p><a href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/" title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)">MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)</a></p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/mysql/do-not-set-too-much-keybuffer/">
        MyISAMを使っている時key_buffer_sizeは大きくし過ぎてもいけない
      </a>
    </h1>

    <time datetime="2012-05-01T13:46:40-07:00" class="post-date">01 May 2012</time>

    <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/mysql/do-not-set-too-much-keybuffer/" class="hatena-bookmark-button" data-hatena-bookmark-title="MyISAMを使っている時key_buffer_sizeは大きくし過ぎてもいけない" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/mysql/do-not-set-too-much-keybuffer/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/mysql/do-not-set-too-much-keybuffer/" data-text="MyISAMを使っている時key_buffer_sizeは大きくし過ぎてもいけない" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/mysql/do-not-set-too-much-keybuffer/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p>MyISAMのみを使っているMySQLサーバで、key_buffer_sizeのサイズは大きくても小さくてもダメですよ、という例。</p>

<p>その前にちょっと復習。MySQLの主なストレージエンジンといえばMyISAMとInnoDBだが、データやインデックスのキャッシュの仕組みには、</p>

<ul>
  <li>InnoDB : インデックス、データともMySQLがキャッシュ管理する(innodb_buffer_pool_sizeで設定)</li>
  <li>MyISAM : インデックスはMySQLがキャッシュ管理する(key_buffer_sizeで大きさを設定)。データはOSのキャッシュ機構におまかせ</li>
</ul>

<p>という違いがある。</p>

<p>ものすごく簡単に言えば、InnoDBの場合はなるべく大きな innodb_buffer_pool_size を設定してやれば、インデックスかデータかに関わらずメモリ上にキャッシュされて高速化が図れる可能性がある。一方MyISAMの場合、key_buffer_size を大きくしてもインデックスしかキャッシュされないので、OSがデータ部分をキャッシュするメモリ(つまりMySQLに割り当ててないメモリ)もある程度確保しておく必要がある。この辺りのことはMySQLのドキュメントには以下のように書かれている。</p>

<blockquote>
  <p>innodb_buffer_pool_size</p>
</blockquote>

<blockquote>
  <p>専用サーバの場合物理メモリの80%。</p>
</blockquote>

<blockquote>
  <p><a title="MySQL 5.1 リファレンスマニュアル 13.5.4. InnoDB 起動オプションとシステム変数" href="http://dev.mysql.com/doc/refman/5.1/ja/innodb-parameters.html" target="_blank">MySQL 5.1 リファレンスマニュアル 13.5.4. InnoDB 起動オプションとシステム変数</a></p>
</blockquote>

<blockquote>
  <p>key_buffer_size</p>
</blockquote>

<blockquote>
  <p>「一般的には、マシンのメモリ使用率 25 % の値であることが好ましい」一方で</p>
</blockquote>

<blockquote>
  <p>「Key_reads/Key_read_requests の比率は、0.01 より小さいことが望ましい」つまり</p>
</blockquote>

<blockquote>
  <p>99.9%がキャッシュされていることが望ましいということ。</p>
</blockquote>

<blockquote>
  <p><a title="MySQL 5.1 リファレンスマニュアル 4.2.3. システム変数" href="http://dev.mysql.com/doc/refman/5.1/ja/server-system-variables.html" target="_blank">MySQL 5.1 リファレンスマニュアル 4.2.3. システム変数</a></p>
</blockquote>

<p>とある参照用のスレーブ(MyISAMのみ使用)で、アクセス数とともにデータ量も増加して、インデックスがメモリに乗りきらず、Key_reads/Key_read_requests (以下key bufferヒット率という)が80%台まで落ちてしまっていた。</p>

<p>メモリを増設してkey_buffer_sizeを調子に乗ってでっかく取ってみたが、key bufferヒット率は99.9%になったものの、相変わらずディスクからの読み出しは多い。ここで、上に書いた仕組みに思い当たり、データ部分をキャッシュするOS用のメモリが不足しているのでは、と思って一旦key_buffer_sizeを少し減らしてみた。</p>

<ul>
  <li>インデックスのサイズ : 22GB</li>
  <li>従来 key_buffer_size : 4GB (OS物理メモリ12GB)</li>
  <li>増強後 key_buffer_size : 12GB (OS物理メモリ24GB)</li>
  <li>その後 key_buffer_size : 8GB (OS物理メモリ24GB)</li>
</ul>

<p>すると一目瞭然、以下のグラフの青枠部のようにディスクからの読み出しは半分以下に減った(赤線が設定を変更した時点)。</p>

<p><a href="http://b.l0g.jp/mysql/do-not-set-too-much-keybuffer/attachment/la-io/" rel="attachment wp-att-1018"><img src="http://b.l0g.jp/wp-content/uploads/2012/04/la-io.png" alt="" title="ロードアベレージとディスクIOの変化" width="522" height="343" class="alignnone size-full wp-image-1018" /></a></p>

<p>key_buffer_sizeを大きくしたからといってパフォーマンスが上がるというわけではないのである。上の例から分かるように、全インデックスがメモリに乗らなくても、よく使うインデックスがほぼメモリに乗っていれば問題ない。常に<strong>key bufferヒット率が最大になり、ディスク読み出しが最小になる key_buffer_size を探ることが必要</strong>ということだ。サイズはオンラインでも変更できる。ただし、コマンドを実行するとkey bufferの中身は一旦空になり、改めてキャッシュが構築されるため一時的にディスクIOが大量に発生するので注意(停止できるサーバならキャッシュウォームアップをした方がよい)。</p>

<p>[sql]</p>

<p>mysql&gt; set global key_buffer_size = バイトでのサイズ(1GBなら1073741824);</p>

<p>[/sql]</p>

<p>確認は show variables で。以下は4GBの例。</p>

<p>[sql]</p>

<p>mysql&gt; show variables like ‘key_buffer_size’;</p>

<p>+—————–+————+</p>

<table>
  <tbody>
    <tr>
      <td>Variable_name</td>
      <td>Value</td>
    </tr>
  </tbody>
</table>

<p>+—————–+————+</p>

<table>
  <tbody>
    <tr>
      <td>key_buffer_size</td>
      <td>4294967296</td>
    </tr>
  </tbody>
</table>

<p>+—————–+————+</p>

<p>1 row in set (0.00 sec)</p>

<p>[/sql]</p>

<p>そもそもインデックスがでか過ぎるのでシェイプアップすべきとか、テーブル分割を考えるべきといった別の解決方法も考えられるのだが、わかりやすいグラフが取れたのでひとつの例として。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page9">Older</a>
  
  
    <a class="pagination-item newer" href="/page7">Newer</a>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T10:52:50-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
