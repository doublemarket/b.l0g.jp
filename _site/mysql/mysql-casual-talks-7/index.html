<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      MySQL Casual Talks Vol. 7まとめ &middot; 渋谷ではたらくインフラエンジニアのブログ
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">MySQL Casual Talks Vol. 7まとめ</h1>
  <time datetime="2014-12-15T01:11:16-08:00" class="post-date">15 Dec 2014</time>
  <p>ふう、<a href="http://mysql-casual.connpass.com/event/9767/">MySQL Casual Talks Vol. 7</a>行って参りました。前回は<a href="http://www.slideshare.net/doublemarket/mysqlcasual6fabric">自分が発表者</a>でもあったので、正直なところ他の人の発表を聞く余裕はなく(汗) 今回は、同僚の発表もあったので楽しみにしていったら、相変わらずの濃ゆい話が盛りだくさんで、非常に楽しめました。毎度の事ながら、<a href="https://twitter.com/myfinder">@myfinderさん</a>始め、会場提供・準備していただいたLINE</p>

<p>のみなさま、Oracleのみなさまに感謝です。</p>

<ul>
  <li><a href="http://togetter.com/li/756928">Togetter</a></li>
</ul>

<h1 id="yoku0825httpstwittercomyoku0825-mysql-fabric"><a href="https://twitter.com/yoku0825">yoku0825さん</a> MySQL Fabricつらい</h1>

<div style="margin-bottom:5px">
  <strong> <a href="//www.slideshare.net/yoku0825/mysql-fabric-42641503" title="MySQL Fabricつらい" target="_blank">MySQL Fabricつらい</a> </strong> from <strong><a href="//www.slideshare.net/yoku0825" target="_blank">yoku0825</a></strong>
</div>

<ul>
  <li>GAから半年なのに誰も使ってない</li>
  <li>アメリカのイベントでは、MySQL Fabricだけに布がプレゼントされた(白目</li>
  <li>Fabric対応コネクタが各種言語向けに用意されてる</li>
  <li><a href="https://github.com/yoku0825/DBD-mysql/tree/support_mysql_fabric">yokuさん謹製fabric対応mysqlクライアント</a>
    <ul>
      <li>fabricとConnector/C経由で通信する</li>
      <li>ro(スレーブ、分散される)とrw(マスタ、当然1台)のモードがある</li>
      <li>マスタを落とすとちゃんと切り替わりますよ(デモ)</li>
    </ul>
  </li>
</ul>

<h1 id="tatsuruhttpstwittercomtatsuru-mysql-on-ec2"><a href="https://twitter.com/tatsuru">tatsuruさん</a> MySQL on EC2</h1>

<ul>
  <li>3年ぐらい運用、結構消耗</li>
  <li>MHA組んでおく
    <ul>
      <li>ENIをつけておいて、マスタ切り替えはそれを付け替える</li>
    </ul>
  </li>
  <li>Mackerelでモニタリング</li>
  <li>バックアップスレーブでsnapshotとってる</li>
  <li>スレーブ作る
    <ul>
      <li>snapshotから作る</li>
      <li>dumpから作る</li>
      <li>落ちたら捨てる前提(信頼性落とす、ダウンしたら捨てる)</li>
    </ul>
  </li>
  <li>取りあえず2セット作って入れ替える、が可能なのがよい</li>
  <li>スレーブのオートスケールは結構難しい
    <ul>
      <li>warmup難しい</li>
      <li>5.7はできそう(buffer poolリストア)</li>
    </ul>
  </li>
  <li>データはEBSに置いている
    <ul>
      <li>IOできなくなって死ぬことがある</li>
      <li>ヘルスチェック工夫しよう</li>
    </ul>
  </li>
  <li>RDSはちょっと高いけど楽
    <ul>
      <li>フェイルオーバーが長い</li>
      <li>可用性がちょっと微妙でやめた(2012年ぐらいの話なので古いかも)</li>
    </ul>
  </li>
  <li>ELBはDNSベースなのでちょっとってことでhaproxyで分散している</li>
  <li>もはや自前でMySQL運用する時代じゃないよね</li>
</ul>

<h1 id="mita2httpstwittercommita2-percona-live"><a href="https://twitter.com/mita2">ヤフー三谷さん @mita2</a> Percona Live行ってきた</h1>

<ul>
  <li>Oracle(200セット), MySQL/Percona(300セット)を運用中
    <ul>
      <li>Exadataとかも</li>
    </ul>
  </li>
  <li>Percona Live 10月にロンドンで開催されたのに参加してきた</li>
  <li>XtraDB Cluster
    <ul>
      <li>ActiveActiveの構成、高い冗長性</li>
      <li>ヨーロッパでは広く普及</li>
      <li>OpenStackのバックエンドに使われている</li>
      <li>本家のGroup Replicationと似てる</li>
      <li>どのノードに書いても同期レプリされる</li>
      <li>MySQL Clusterよりは本家MySQLに近くてハードル低い</li>
      <li>Writeのスケールはできない(MySQL Cluster使おう)</li>
      <li>SST(丸ごとコピー)、IST(差分)でDonorからデータを送る</li>
      <li>ノードへの分散はHAProxyとか使う</li>
      <li>ヘルスチェックの仕組みもXtraDB型に準備されてる</li>
      <li>書き込みは楽観的ロック</li>
      <li>コミットしてノード間の情報が食い違ってるとコミット時にエラー</li>
      <li>従って書き込みはできるだけ1台がいい</li>
      <li>オンラインalterはできない(今後サポート予定)ので、ローリングで変更していく</li>
    </ul>
  </li>
</ul>

<h1 id="okumura-hfmhttpstwittercomhfm-mysql-40"><a href="https://twitter.com/hfm">ペパボ okumuraさん @hfm</a> MySQL 4.0をリプレイスした</h1>

<div style="margin-bottom:5px">
  <strong> <a href="//www.slideshare.net/hifumis/mysql-casual-42634961" title="MySQL 4.0で9年動き続けたサーバを リプレイスしてバージョンアップした話" target="_blank">MySQL 4.0で9年動き続けたサーバを リプレイスしてバージョンアップした話</a> </strong> from <strong><a href="//www.slideshare.net/hifumis" target="_blank">Takahiro Okumura</a></strong>
</div>

<ul>
  <li><a href="http://blog.hifumi.info/2014/12/13/mysql-casual-vol-7/">ブログ記事</a></li>
  <li>2005年 4.0.25 -&gt; 9年 -&gt; 5.0.96にバージョンアップ</li>
  <li>@tnmt 氏がカジュアルに5.6バージョンアップを指示するイシューを投げたところから始まった</li>
  <li>しかしやる事になった時は何にも知識ありませんでした</li>
  <li>たくさんの爆弾が仕込まれていた。。
    <ul>
      <li>マスタとスレーブの食い違いなどなど</li>
      <li>ハードもソフトも古い</li>
    </ul>
  </li>
  <li>検証の過程で色んなバージョンをインストールしたので、MySQL-AllStarというbox提供してます(4.0から5.6まで全部入り)</li>
  <li>結局5.0まで上げることに</li>
  <li>6/20 イベントがあるとレンタルサーバのアクセスが減るからwという理由でメンテ実施
    <ul>
      <li>ダンプからリストア、切り替えまで同じタイミングでやった</li>
      <li>insertを実行するとbinlogが壊れることが発覚</li>
      <li>失敗として切り戻し</li>
      <li>5.0系を特定のgccでコンパイルすると起きるバグ？</li>
      <li>gccの最適化のレベルによってテストが通ったり通らなかったり</li>
    </ul>
  </li>
  <li>その後別のバグ発生
    <ul>
      <li>rpmbuild中に必要なファイルが消える</li>
      <li>邪魔してたパッケージ消してビルド成功</li>
    </ul>
  </li>
  <li>8/22無事バージョンアップ成功</li>
  <li>4.0に入っていたデータの一部がリカバリできなかったのは手動で戻した</li>
</ul>

<h1 id="strsk-httpstwittercomstrsk-db"><a href="https://twitter.com/strsk">サイバーエージェント @strsk さん</a> ソーシャルゲームDBの危機回避</h1>

<ul>
  <li><a href="http://strsk.hatenablog.com/entry/2014/12/15/123211">ブログ記事</a></li>
  <li>ギフトとかカードの情報が増えまくる
    <ul>
      <li>1日数十GB、論削だけで物理削除してなかったり</li>
      <li>削除するのではなく、必要なデータだけをINSERT SELECTで抽出してテーブルを作り直すと速い</li>
      <li>deleteしてもテーブル容量減らない(MVCCのバージョン管理のため)</li>
      <li>pt-online-schema-changeでテーブル再構築</li>
    </ul>
  </li>
  <li>レプリ遅延
    <ul>
      <li>truncateすると遅れる(deleteより遅い)</li>
      <li>バッファプールを大きく使ってると遅くなるというバグ</li>
      <li>結局deleteしました</li>
    </ul>
  </li>
</ul>

<h1 id="ryopeko-httpstwittercomryopeko-q4m"><a href="https://twitter.com/ryopeko">@ryopeko さん</a> Q4M</h1>

<ul>
  <li><a href="http://qiita.com/ryopeko/items/f42b65a11d7f1f74311e">ブログ記事</a></li>
  <li>パーフェクトRuby出しました</li>
  <li>Rubyの人はRedis使う人多い(sidekiqで)けどQ4M
    <ul>
      <li><a href="https://github.com/ryopeko/shinq">shinq</a></li>
      <li>ActiveJobを利用</li>
      <li>Rails 4.2に入る予定のキュー機能</li>
    </ul>
  </li>
</ul>

<h1 id="kakerukaeru-httpstwittercomkakerukaeru-continuous-restore"><a href="https://twitter.com/kakerukaeru">サイバーエージェント @kakerukaeru さん</a> continuous restore</h1>

<ul>
  <li><a href="http://kakerukaeru.hatenablog.com/entry/2014/12/13/213342">ブログ記事</a></li>
  <li>DBのバックアップだけじゃなくてリストアも繰り返しやって、復旧可能性を担保</li>
  <li>バァーン、バァーン、バババァーン</li>
</ul>

<h1 id="ijin-httpstwittercomijin-consulmysql"><a href="https://twitter.com/ijin">@ijin さん</a> ConsulでMySQLのフェイルオーバー</h1>

<ul>
  <li><a href="http://ijin.github.io/blog/2014/07/11/mysql-failover-with-consul/">元ネタのブログ記事</a></li>
  <li>consulはraftを使ってcap定理のcpを実現している</li>
  <li>MHA発動時に実行されるfailover scriptでconsulのAPIを叩いてマスタのDNS名を変更する</li>
  <li>consul event
    <ul>
      <li>eventをノードに伝えると伝播される(no guarantee)</li>
      <li>watchで検知してスクリプトを動かす</li>
    </ul>
  </li>
  <li>consul templateを使いましょう</li>
</ul>

<h1 id="kazeburo-httpstwittercomkazeburo-isuconmysql"><a href="https://twitter.com/kazeburo">@kazeburo さん</a> isuconのためのMySQLチューニング</h1>

<div style="margin-bottom:5px">
  <strong> <a href="//www.slideshare.net/kazeburo/mysql-casual7isucon" title="ISUCON4 予選問題で(中略)、”my.cnf”に1行だけ足して予選通過ラインを突破するの術" target="_blank">ISUCON4 予選問題で(中略)、”my.cnf”に1行だけ足して予選通過ラインを突破するの術</a> </strong> from <strong><a href="//www.slideshare.net/kazeburo" target="_blank">Masahiro Nagano</a></strong>
</div>

<ul>
  <li>my.cnfをチューニングする
    <ul>
      <li>innodb_flush_log_at_trx_commit=2で結構上がる</li>
      <li>innodb_flush_method=nosync/O_DIRECTでも上がる</li>
      <li>この2つのオプションさえちゃんとやっておけばおk</li>
      <li>データ量に応じてinnodb_buffer_pool_sizeも</li>
    </ul>
  </li>
</ul>

<h1 id="neofact-httpstwittercomneofact-kuwatw-httpstwittercomkuwatw-nvmfs"><a href="https://twitter.com/neofact">@neofact さん</a>、 <a href="https://twitter.com/kuwa_tw">@kuwa_tw さん</a> NVMFS</h1>

<div style="margin-bottom:5px">
  <strong> <a href="//www.slideshare.net/akuwano/ca-nvmfs-42665725" title="NVMFS 使ってみたとか 言っちゃって マジカジュアルな奴" target="_blank">NVMFS 使ってみたとか 言っちゃって マジカジュアルな奴</a> </strong> from <strong><a href="//www.slideshare.net/akuwano" target="_blank">Akihiro Kuwano</a></strong>
</div>

<ul>
  <li><a href="http://d.hatena.ne.jp/akuwano/20141215">ブログ記事</a></li>
  <li>圧縮効いて8〜6割の性能</li>
  <li>容量的には半分ぐらいに圧縮できた</li>
  <li>圧縮伸長でCPU食う(元々ioDriveではCPUバウンドだけどさらにきつくなる)</li>
</ul>

<h1 id="doaki-httpstwittercomdoaki-n1"><a href="https://twitter.com/do_aki">@do_aki さん</a> N:1レプリケーション</h1>

<ul>
  <li>いつもの</li>
  <li>特に進捗なし</li>
  <li>Raspberry piでN:1 replication動きましたw</li>
</ul>

<h1 id="kamipo-httpstwittercomkamipo-activerecord"><a href="https://twitter.com/kamipo">@kamipo さん</a> ActiveRecord</h1>

<ul>
  <li>
    <p><a href="http://kamipo.github.io/talks/20141212-mysqlcasual7/#/title">発表資料</a></p>
  </li>
  <li>
    <p>ARのメンテナはみんなPostgreSQL派で、MySQLのプルリクは放置される傾向にある</p>
  </li>
  <li><a href="https://github.com/rails/rails/pulls/kamipo">いっぱいMySQLのプルリク投げた！</a>
    <ul>
      <li>For MySQLってつけたの全部放置されてるorz</li>
      <li>機能をバックポートして<a href="http://qiita.com/kamipo/items/11b55caf329210923a9a">activerecord-mysql-awesome作った</a></li>
    </ul>
  </li>
  <li>kamipoさんはすごいひと</li>
</ul>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/aws/periodic-ebs-snapshot/">
          AWSのEBSボリュームのスナップショットを定期的に取る
          <small><time datetime="2015-10-19T06:33:30-07:00">19 Oct 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/misc/my-twitter-bots/">
          Twitterボットを作るのがひそかな趣味
          <small><time datetime="2015-05-22T06:26:26-07:00">22 May 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/uncategorized/sql-performance-explained-ja/">
          「SQLパフォーマンス詳解」という本を翻訳しました
          <small><time datetime="2015-04-07T01:45:15-07:00">07 Apr 2015</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T11:57:39-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
