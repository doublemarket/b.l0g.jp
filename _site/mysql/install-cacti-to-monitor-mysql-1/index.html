<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編) &middot; 渋谷ではたらくインフラエンジニアのブログ
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)</h1>
  <time datetime="2012-05-17T13:01:24-07:00" class="post-date">17 May 2012</time>
  <div class="wp_social_bookmarking_light">
  <div class="wsbl_hatena_button">
    <a href="http://b.hatena.ne.jp/entry/http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" class="hatena-bookmark-button" data-hatena-bookmark-title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)" data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"> <img src="//b.hatena.ne.jp/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
  </div>
  
  <div class="wsbl_facebook_like">
    <div id="fb-root">
    </div><fb:like href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" layout="button_count" action="like" width="100" share="false" show_faces="false"></fb:like>
  </div>
  
  <div class="wsbl_twitter">
    &lt;a href="https://twitter.com/share" class="twitter-share-button"{count} data-url="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/" data-text="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視サーバ構築編)" data-via="dblmkt " data-lang="ja"&gt;Tweet
  </div>
  
  <div class="wsbl_google_plus_one">
    <g:plusone size="medium" annotation="none" href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/"></g:plusone>
  </div>
</div>

<p><br class="wp_social_bookmarking_light_clear" /></p>

<p>MySQLをリソース監視する仕組みにはいくつかあるが、対象のMySQLサーバが5台以上ある場合はCactiがおすすめ。導入のしやすさだけでMuninを選ぶ人が多い気がするが、その選択基準は間違っている！</p>

<p><a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/attachment/cacti-211916/" rel="attachment wp-att-1173"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/Cacti-211916.png" title="Cactiグラフの例" width="223" height="256" class="alignleft  wp-image-1173" style="margin-top: 0px; margin-bottom: 0px; margin-left: 10px; margin-right: 40px; border-style: initial; border-color: initial; border-image: initial; border-width: 0px;" /></a></p>

<p> </p>

<p><strong>Cactiのいいとこわるいとこ</strong></p>

<ul>
  <li>多数のグラフを見やすく並べられる</li>
  <li>muninと比べて多数のサーバから軽快に情報を収集・表示できる</li>
  <li>監視対象には、MySQLのユーザを追加するだけでかなりの項目数を監視できる</li>
  <li>データの保存にデータベースが必須だったりしてセットアップがやや面倒</li>
  <li>慣れるまで監視プラグインを書くのに手間取る</li>
</ul>

<p><strong>Muninのいいとこわるいとこ</strong></p>

<ul>
  <li>監視プラグインを書くのが簡単</li>
  <li>監視サーバにデータベースなどが必要なく、セットアップが簡単</li>
  <li>グラフの並び方などが固定で、比較などがしにくい</li>
  <li>監視対象にプラグインを入れなければならず、台数が多いとそれだけ手間が増える</li>
  <li>監視対象が増えると監視サーバの負荷が急激にあがるので、あまり多数のサーバは監視できない</li>
</ul>

<p>そんなわけで、CentOS 6.2上にCactiの監視サーバをセットアップし、<a title="Percona Monitoring Plugin" href="http://www.percona.com/software/percona-monitoring-plugins/" target="_blank">Percona Monitoring Plugins for Cacti</a>を使ってMySQLサーバ(CentOSまたはUbuntu)のリソース監視を始めるまでの手順。その1は監視サーバのセットアップ編。</p>

<h2 id="rpmforge">RPMforgeのリポジトリ追加</h2>

<p>RPMforgeリポジトリには最新のCactiが含まれているため、これを導入する。</p>

<p>[bash]</p>

<p>$ wget http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm</p>

<p>$ sudo rpm -ihv rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm</p>

<p>$ sudo yum -y update rpmforge-release</p>

<p>[/bash]</p>

<p>/etc/yum.repos.d/rpmforge.repo ファイルをエディタで開き、 enabled = 0 にする。これで、オプションを付けないとRPMforgeはリポジトリとして有効にならないようになる。</p>

<h2 id="cacti">Cactiのインストール</h2>

<p>Cactiと、あわせて必要なnet-snmpやhttpd、MySQLなどをインストール。</p>

<p>[bash]</p>

<p>$ sudo yum install –enablerepo=rpmforge cacti net-snmp-utils mysql-server</p>

<p>[/bash]</p>

<p>指定したもの以外に、依存関係上httpd, mysql, perl, php, rrdtoolなどもインストールされる。</p>

<h2 id="mysql">MySQLの設定</h2>

<p>Cactiが取得した情報を格納するためのMySQLを設定する。ここでは最低限必要な設定だけを記述するが、CentOS 6.2のMySQLの/etc/my.cnfは非常にシンプルなので、必要に応じてパラメータを指定すること。</p>

<p>[mysqld]セクションに以下を追加</p>

<p>[text]</p>

<p>skip-character-set-client-handshake</p>

<p>character-set-server = utf8</p>

<p>collation-server = utf8_general_ci</p>

<p>init-connect = SET NAMES utf8</p>

<p>[/text]</p>

<p>(2012.05.29) default-character-setは不要とnippondanjiさんからはてブコメントで指摘をいただいたので削除。直々にご指摘とは恐縮です。</p>

<p>ここでMySQLを再起動する。</p>

<p>[bash]</p>

<p>$ sudo /etc/init.d/mysqld restart</p>

<p>[/bash]</p>

<p>statusコマンドで、charactersetがutf8であることを確認。</p>

<p>[sql]</p>

<p>mysql&gt; status;</p>

<p>(略)</p>

<p>Server characterset: utf8</p>

<p>Db characterset: utf8</p>

<p>Client characterset: utf8</p>

<p>Conn. characterset: utf8</p>

<p>(略)</p>

<p>[/sql]</p>

<p><a href="http://docs.cacti.net/manual:088:1_installation.1_install_unix.5_install_and_configure_cacti" target="_blank">Cactiのドキュメント</a>にしたがって、Cactiで使用するMySQLの設定を行う。</p>

<p>[sql]</p>

<p>$ mysqladmin –user=root create cacti</p>

<p>$ mysql cacti &lt; cacti.sql</p>

<p>$ mysql –user=root mysql</p>

<p>mysql&gt; grant all on cacti.* to ユーザ名@localhost identified by ‘パスワード’;</p>

<p>mysql&gt; flush privileges;</p>

<p>[/sql]</p>

<h2 id="apachephp">Apache/PHPの設定</h2>

<p>/var/www/cacti/include/config.php を上の項で作成したユーザに合わせて編集する。</p>

<p>[text]</p>

<p>$database_type = “mysql”;</p>

<p>$database_default = “cacti”;</p>

<p>$database_hostname = “localhost”; # DBサーバのホスト名</p>

<p>$database_username = “cactiuser”; # 上の項で作成したユーザ</p>

<p>$database_password = “cactipassword”; # 上の項で設定したパスワード</p>

<p>[/text]</p>

<p>/etc/httpd/conf.d/cacti.php が存在することを確認する。他のホストからCactiにアクセスする際は、以下の行を追加してhttpdを再起動する。</p>

<p>[text]</p>

<p>allow from 127.0.0.1</p>

<p>allow from IPアドレス # 追記</p>

<p>[/text]</p>

<p><a href="http://docs.cacti.net/manual:088:1_installation.1_install_unix.1_configure_php" target="_blank">Cactiのドキュメント</a>を参考に、/etc/php.ini および /etc/php.d/*.ini の記述を確認。設定を変更したら、Apacheを再起動する。</p>

<p>[bash]</p>

<p>$ sudo /etc/init.d/httpd restart</p>

<p>[/bash]</p>

<h2 id="iptables">iptablesの設定</h2>

<p>CentOS 6.2ではデフォルトでpingやSSHしか応答できないようにされているようなので、/etc/sysconfig/iptables に以下を追加してhttpのアクセスが可能なようにする。</p>

<p>[text]</p>

<p>-A INPUT -m state –state NEW -m tcp -p tcp –dport 80 -j ACCEPT</p>

<p>[/text]</p>

<p>iptablesを再起動</p>

<p>[text]</p>

<p>$ sudo /etc/init.d/iptables restart</p>

<p>[/text]</p>

<h2 id="section">設定完了</h2>

<p>Cactiをインストールした際に /etc/cron.d/cacti が既に作成されているので、この時点で5分おきに情報収集が始まっている。</p>

<p>http://CactiサーバのIPアドレス/cacti を開くと、まずインストールの確認ウィザードが開始される。</p>

<p style="text-align: center;">
  <a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/attachment/03-2/" rel="attachment wp-att-1159"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/03.png" title="インストール確認ウィザード" width="305" height="244" class="size-full wp-image-1159 aligncenter" style="border-style: initial; border-color: initial; border-image: initial; border-width: 0px;" /></a>
</p>

<p>ここまでの設定を改めて確認されるだけなので、基本的にはNextを押していけばいい。各種ツールのパスを確認される画面が最後にあるが、ここでパスが見つからない場合は手動でパスを入力するか、不足しているツールをインストールして再度試すべし。</p>

<p>この後ログイン画面が表示され、ユーザ名 admin 、 パスワード admin でログイン可能で、すぐにパスワードの変更を促されるので画面の指示に従って変更する。</p>

<h2 id="percona-monitoring-plugin-for-cacti">Percona Monitoring Plugin for Cactiの導入</h2>

<p><a href="http://www.percona.com/downloads/percona-monitoring-plugins/" target="_blank">Percona</a>からPercona monitoring pluginsをダウンロードし、ファイルを展開する。</p>

<p>[bash]</p>

<p>$ tar zxvf percona-monitoring-plugins-1.0.0.tar.gz</p>

<p>$ cd percona-monitoring-plugins-1.0.0/cacti/scripts</p>

<p>$ sudo cp ss_get_by_ssh.php ss_get_mysql_stats.php /var/www/cacti/scripts/</p>

<p>[/bash]</p>

<p>監視対象のMySQLにログインする際のアカウント情報を ss_get_mysql_stats.php に書き込む。</p>

<p>[text]</p>

<p>$mysql_user = ‘cactiuser’; # 監視対象にログインする際のMySQLユーザ</p>

<p>$mysql_pass = ‘cactiuser’; # 監視対象にログインする際のパスワード</p>

<p>[/text]</p>

<p>Cacti管理画面からImport/Export → Import templatesを選択し、Import Template from Local Fileで以下を指定してImportボタンを押し、テンプレートファイルを読み込ませる。</p>

<p>[text]</p>

<p>percona-monitoring-plugins-1.0.0/cacti/templates/cacti_host_template_percona_mysql_server_ht_0.8.6i-sver1.0.0.xml</p>

<p>[/text]</p>

<p>成功すると、それぞれの監視項目に対応したテンプレートごとに[success]と表示される。</p>

<p style="text-align: center;">
  <a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/attachment/04-2/" rel="attachment wp-att-1160"><img src="http://b.l0g.jp/wp-content/uploads/2012/05/04.png" title="テンプレート読み込み" width="360" height="393" class="size-full wp-image-1160 aligncenter" style="border-style: initial; border-color: initial; border-image: initial; border-width: 0px;" /></a>
</p>

<p>これでMySQLサーバを監視するための監視サーバの準備は完了。</p>

<p>(2012.05.28追記) 監視対象側の設定についても書いたので、続けてどうぞ。</p>

<p><a href="http://b.l0g.jp/mysql/use-cacti-to-monitor-mysql-2/" title="MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)">MySQLの監視はCacti+Percona Monitoring Pluginsがおすすめ(監視対象設定編)</a></p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/aws/periodic-ebs-snapshot/">
          AWSのEBSボリュームのスナップショットを定期的に取る
          <small><time datetime="2015-10-19T06:33:30-07:00">19 Oct 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/misc/my-twitter-bots/">
          Twitterボットを作るのがひそかな趣味
          <small><time datetime="2015-05-22T06:26:26-07:00">22 May 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/uncategorized/sql-performance-explained-ja/">
          「SQLパフォーマンス詳解」という本を翻訳しました
          <small><time datetime="2015-04-07T01:45:15-07:00">07 Apr 2015</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T10:52:50-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
