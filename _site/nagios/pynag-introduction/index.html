<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Nagiosのプラグイン作成や設定ファイル操作にpynagが超便利！ &middot; 渋谷ではたらくインフラエンジニアのブログ
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Nagiosのプラグイン作成や設定ファイル操作にpynagが超便利！</h1>
  <time datetime="2013-06-12T02:51:05-07:00" class="post-date">12 Jun 2013</time>
  <p>Nagiosの設定ファイルをパースする簡単な方法ないかなと思って調べてたら、<a href="http://pynag.org/" title="pynag.org" target="_blank">pynag</a>という超便利なパッケージ発見。日本語の情報ほとんどないけど、Fedoraの標準パッケージになっているってことは割と一般的なんだろうか。</p>

<ul>
  <li>Nagiosのプラグインを簡単に作りたい</li>
  <li>Nagiosの設定ファイルをパースして値を取りたい</li>
  <li>Nagiosの設定をコマンドラインやプログラムから取得・変更したい</li>
</ul>

<p>って時に重宝する。pynagという名の通り、pythonで書かれている。公式ページのそのまんま訳に近いけど、使い方ご紹介。</p>

<h2 id="section">インストール</h2>

<p>Fedoraの最近のバージョンには標準で含まれており、CentOSやRHELならepelを使えるようにしておけばyumでインストールできる。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo yum install http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm
  
$ sudo yum install pynag
  
</code></pre>
</div>

<p>pipが使えるならpipでもインストールできる。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo pip install pynag
  
</code></pre>
</div>

<h2 id="section-1">設定ファイルのパース</h2>

<p>pynagパッケージのModelモジュールを使えば、 /etc/nagios など代表的なパスから nagios.cfg を探し出して読み込んでくれる。含まれるホストとそのホストに関連づいたContact groupを表示する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
from pynag import Model

# Get all hosts
  
all_hosts = Model.Host.objects.all
  
for i in all_hosts:
      
print i.host_name, i.contact_groups
  
</code></pre>
</div>

<h2 id="section-2">設定書き換え</h2>

<p>同じようにして、設定を保存することもできる。ホスト名がexamplehostのホストのContact groupを「mycontactgroup」にする例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
from pynag import Model

services = Model.Service.objects.filter(host_name='examplehost')
  
for i in services:
    
i.contactgroups = "mycontactgroup"
    
i.save()
  
</code></pre>
</div>

<h2 id="section-3">ステータスの取得</h2>

<p>監視結果が保存されているstatus.datファイルのパースもしてくれるので、ホストやサービスのステータス取得もできる。</p>

<p>ホストグループ名とサービス名を引数に与えてやると、ホストグループに所属するホスト全てに関するサービスのステータスを返すスクリプト。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
import sys
  
from pynag import Model
  
from pynag.Parsers import status

argvs = sys.argv
  
argc = len(argvs)
  
status = status()

if (argc != 3):
          
print
          
print("Usage: ./%s hostgroup service" % argvs[0])
          
print
          
sys.exit()

hostgroups = Model.Hostgroup.objects.filter(hostgroup_name=argvs[1])
  
for hostgroup in hostgroups:
          
print("Hostgroup: %s" % hostgroup.hostgroup_name)
          
print("Member:")
          
for host in hostgroup.members.split(','):
                  
print("%s %s" % (host, status.get_servicestatus(host, argvs[2])['current_state']))
  
</code></pre>
</div>

<p>status.datのパースにはやや時間がかかるので、監視対象サーバの台数が多いと使用に耐えない。そういう場合は、高速にステータスを取得できる<a href="http://mathias-kettner.de/checkmk_livestatus.html" title="MK Livestatus" target="_blank">MK Livestatus</a>と組み合わせることもできる。インストール方法は割愛するのでWebページを参照するべし。MK Livestatusを使って、上のスクリプトと同じようにホストグループとサービス名を引数に与えてホストのステータスを取得する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
import sys
  
from pynag import Model
  
from pynag.Parsers import mk_livestatus

argvs = sys.argv
  
argc = len(argvs)
  
livestatus = mk_livestatus()

if (argc != 3):
          
print
          
print("Usage: ./%s hostgroup service" % argvs[0])
          
print
          
sys.exit()

hostgroups = Model.Hostgroup.objects.filter(hostgroup_name=argvs[1])
  
for hostgroup in hostgroups:
          
print("Hostgroup: %s" % hostgroup.hostgroup_name)
          
print("Member:")
          
for host in hostgroup.members.split(','):
                  
print(host)
                  
print(livestatus.get_service(host,argvs[2])['host_services_with_info'])
  
</code></pre>
</div>

<h2 id="section-4">コマンドラインから使う</h2>

<p>Pythonのスクリプト内だけでなく、pynagコマンドとしてシェルから直接使うこともできる。where句で対象を絞ることが可能。</p>

<p>全ホストオブジェクトを表示する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ pynag list where object_type=host
  
object_type shortname filename
  
——————————————————————————-
  
host server01 /etc/nagios/Default_collector/hosts.cfg
  
host server02 /etc/nagios/Default_collector/hosts.cfg
  
(中略)
  
———-123 objects matches search condition———————————-
  
</code></pre>
</div>

<p>MySQL_Connect_cというサービスのチェックコマンドを表示する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ pynag list effective_command_line where service_description=MySQL_Connect_c
  
effective_command_line
  
——————————————————————————-
  
/usr/lib64/nagios/plugins/check_mysql_health -hostname -user nagios -password nagios -mode connection-time -database test -critical 1
  
———-1 objects matches search condition————————————
  
</code></pre>
</div>

<p>もちろんコマンドラインから設定の変更も可能。ホスト名server01をserver02に変更する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ pynag update set host_name=server02 where host_name=server01 and object_type=host
  
</code></pre>
</div>

<p>where句にはlikeのような部分一致が使えないようだ。複雑なクエリを発行したいときは、pythonスクリプトとして作った方がいいかもしれない。コマンドラインでの使い方は<a href="https://github.com/pynag/pynag/wiki/Pynag-command-line-utility" title="pynag wiki" target="_blank">Wiki</a>にもう少し詳しく書いてある。</p>

<h2 id="nagios">Nagiosプラグイン作成時に使う</h2>

<p>個人的に一番ツボなのがこの機能。自作のプラグインに、Nagiosのプラグインを書く際のガイドラインに準じた引数の処理などを簡単に加えることができる。</p>

<p>/proc/loadavgの中身から、ロードアベレージを引いてくる簡単な例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
<span class="c">#!/usr/bin/python</span>
  
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>

<span class="c">## プラグインのオプションを生成</span>
  
<span class="n">np</span> <span class="o">=</span> <span class="n">Plugin</span><span class="p">()</span>

<span class="c">## コマンドライン引数を追加</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_arg</span><span class="p">(</span><span class="s">"l"</span><span class="p">,</span><span class="s">"load-file"</span><span class="p">,</span> <span class="s">"Enter a load average file"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="c">## プラグインをアクティベート</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

<span class="c">## load-fileオプションが指定されたらそのファイルからLAを読み込む</span>
  
<span class="c">## デバッグと、add_argメソッドのサンプルとして</span>
  
<span class="k">if</span> <span class="n">np</span><span class="p">[</span><span class="s">'load-file'</span><span class="p">]:</span>
      
<span class="n">load_file</span> <span class="o">=</span> <span class="n">np</span><span class="p">[</span><span class="s">'load-file'</span><span class="p">]</span>
  
<span class="k">else</span><span class="p">:</span>
      
<span class="n">load_file</span> <span class="o">=</span> <span class="s">"/proc/loadavg"</span>

<span class="c">## ちょっとしたエラーチェック</span>
  
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">load_file</span><span class="p">):</span>
      
<span class="n">np</span><span class="o">.</span><span class="n">nagios_exit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="s">"Missing Load average file </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">load_file</span><span class="p">)</span>

<span class="c">## チェックに使う値を取得</span>
  
<span class="n">current_load</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"cat </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">load_file</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="c">## パフォーマンスデータを付加</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_perfdata</span><span class="p">(</span><span class="s">"1min"</span><span class="p">,</span> <span class="n">current_load</span><span class="p">)</span>

<span class="c">## チェック実行</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">check_range</span><span class="p">(</span><span class="n">current_load</span><span class="p">)</span>
  
</code></pre>
</div>

<p>上のスクリプトをcheck_cpu.pyとして保存しておく。5行目のPlugin()で、プラグインとして必要なオプションが用意されるので、以下のようにスクリプトに引数を指定しないで実行しただけで、簡易ヘルプが表示される。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ ./check_load.py
  
usage: check_load.py [options]

check_load.py: error: You must provide a WARNING and/or CRITICAL value
  
</code></pre>
</div>

<p>さらに、-hオプションをつけると、詳細なヘルプが表示される。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ ./check_load.py -h
  
usage: check_load.py [options]

options:
    
-h, -help show this help message and exit
    
-l LOAD-FILE, -load-file=LOAD-FILE
                          
Enter a load average file
    
-v VERBOSE, -verbose=VERBOSE
                          
Verbosity Level
    
-H HOST, -host=HOST Target Host
    
-t TIMEOUT, -timeout=TIMEOUT
                          
Connection Timeout
    
-c CRITICAL, -critical=CRITICAL
                          
Critical Threshhold
    
-w WARNING, -warning=WARNING
                          
Warn Threshhold
  
</code></pre>
</div>

<p>ここで、スクリプト内の8行目、add_argメソッドで追加したオプションが、ヘルプの中に「-l LOAD-FILE, -load-file=LOAD-FILE」として表示されている。また、-Hでの監視対象ホスト指定や-c,-wによる閾値の指定オプションがはじめから用意されていることがわかる。自作スクリプトを書くたびにオプションのパースから書いていた事を考えれば、なんという簡単さ！</p>

<p>もちろん、ヘルプでみたとおりのオプションを与えてやれば、プラグインとして使用可能。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ uptime
   
13:16:19 up 396 days, 22:32, 3 users, load average: 0.60, 1.08, 1.04

$ ./check_load.py -w 1 127.0.0.1
  
OK: 0.60 is inside warning=1 and critical=None | '1min'=0.60;;;;
  
</code></pre>
</div>

<p>元々やりたかったのは「同一ホストグループ内のある台数のチェック失敗まではWARNING、その台数以上のチェック失敗でCRITICALアラートを上げたい」ということだったのだが、以下のような短いプラグインスクリプトで実現できた。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
<span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">sys</span>
  
<span class="kn">from</span> <span class="nn">pynag</span> <span class="kn">import</span> <span class="n">Model</span>
  
<span class="kn">from</span> <span class="nn">pynag.Parsers</span> <span class="kn">import</span> <span class="n">status</span>
  
<span class="kn">from</span> <span class="nn">pynag.Plugins</span> <span class="kn">import</span> <span class="n">simple</span> <span class="k">as</span> <span class="n">Plugin</span>

<span class="n">np</span> <span class="o">=</span> <span class="n">Plugin</span><span class="p">()</span>
  
<span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">()</span>

<span class="n">np</span><span class="o">.</span><span class="n">add_arg</span><span class="p">(</span><span class="s">"g"</span><span class="p">,</span> <span class="s">"hostgroup"</span><span class="p">,</span> <span class="s">"Hostgroup name"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_arg</span><span class="p">(</span><span class="s">"s"</span><span class="p">,</span> <span class="s">"service"</span><span class="p">,</span> <span class="s">"Service name"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

<span class="n">errornum</span> <span class="o">=</span> <span class="mi">0</span>
  
<span class="n">hostgroups</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">Hostgroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">hostgroup_name</span><span class="o">=</span><span class="n">np</span><span class="p">[</span><span class="s">'hostgroup'</span><span class="p">])</span>
  
<span class="k">for</span> <span class="n">hostgroup</span> <span class="ow">in</span> <span class="n">hostgroups</span><span class="p">:</span>
          
<span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hostgroup</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">):</span>
                  
<span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get_servicestatus</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">np</span><span class="p">[</span><span class="s">'service'</span><span class="p">])[</span><span class="s">'current_state'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"0"</span><span class="p">:</span>
                          
<span class="n">errornum</span> <span class="o">=</span> <span class="n">errornum</span> <span class="o">+</span> <span class="mi">1</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_perfdata</span><span class="p">(</span><span class="s">"WARN/CRIT"</span><span class="p">,</span> <span class="n">errornum</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">check_range</span><span class="p">(</span><span class="n">errornum</span><span class="p">)</span>
  
</code></pre>
</div>

<p>2台のチェックに失敗している時の例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
# 2より多いとwarn、3より多いとcrit
  
$ python check_wipeout.py -hostgroup=common_dbs -service=ifSpeed_eth0_w -w 2 -c 3
  
OK: 2 is inside warning=2 and critical=3 | 'WARN/CRIT'=2;;;;

$ echo $?
  


# 1より多いとwarn、3より多いとcrit
  
$ python check_wipeout.py -hostgroup=common_dbs -service=ifSpeed_eth0_w -w 1 -c 3
  
WARNING: 2 is outside warning range: 1 | 'WARN/CRIT'=2;;;;

$ echo $?
  
1

# 1より多いとcrit
  
$ python check_wipeout.py -hostgroup=common_dbs -service=ifSpeed_eth0_w -c 1
  
CRITICAL: 2 is outside critical range: 1 | 'WARN/CRIT'=2;;;;
  
$ echo $?
  
2
  
</code></pre>
</div>

<p>というわけで、pynagがあるとNagiosプラグインを書くのが超簡単になる！ pynag万歳！</p>

<p>ドキュメントは<a href="https://github.com/pynag/pynag/wiki" title="pynag wiki" target="_blank">Github上のWiki</a>を見るとよい。Wikiからだと分からない部分も多いが、<a href="https://github.com/pynag/pynag" title="pynag" target="_blank">ソース自体</a>はそれほど複雑ではないので読んでみればわかるのでは。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/aws/periodic-ebs-snapshot/">
          AWSのEBSボリュームのスナップショットを定期的に取る
          <small><time datetime="2015-10-19T06:33:30-07:00">19 Oct 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/misc/my-twitter-bots/">
          Twitterボットを作るのがひそかな趣味
          <small><time datetime="2015-05-22T06:26:26-07:00">22 May 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/uncategorized/sql-performance-explained-ja/">
          「SQLパフォーマンス詳解」という本を翻訳しました
          <small><time datetime="2015-04-07T01:45:15-07:00">07 Apr 2015</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T11:57:39-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
