<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      AWSのEBSボリュームのスナップショットを定期的に取る &middot; 渋谷ではたらくインフラエンジニアのブログ
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">AWSのEBSボリュームのスナップショットを定期的に取る</h1>
  <time datetime="2015-10-19T06:33:30-07:00" class="post-date">19 Oct 2015</time>
  <p>小ネタだけど、久しぶりに技術的な内容の記事を書いてみる。最近はこういうのはQiitaに書くのが流行り？</p>

<h2 id="ebs">EBSボリュームのスナップショット</h2>

<p>インスタンスストレージ(インスタンスに無料で付いてくるローカルストレージ)と比べてEBSを使うことの利点の一つに、スナップショットを取れるというのがある。これはもちろん<a href="http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html">AWSのコンソールからの操作</a>でも、<a href="https://aws.amazon.com/jp/cli/">awscli</a>のようなツールを使ってもできるんだけど、いちいちこれらの操作をやるのは面倒になってくる。そうすると、</p>

<ul>
  <li>自動で定期的にスナップショットを取りたい</li>
  <li>古いスナップショットは自動的に消したい</li>
  <li>複数のEBSボリュームのスナップショットをまとめて取りたい</li>
  <li>全ボリュームのスナップショットを取る必要はなく、一部だけ取っておきたい</li>
</ul>

<p>みたいな話が出てくる。</p>

<p>そういう時にはもちろんawscliや各言語のSDKを使って自分でこれを実装してもいいのだが、<a href="https://github.com/colinbjohnson/aws-missing-tools">AWS Missing Tools</a>と言う、AWSに関するちょっと痒いところに手が届くツール集があって、これに含まれるEBSスナップショット取得用のスクリプト ec2-automate-backup.sh を使うと便利。</p>

<h2 id="ec2-automate-backupsh">ec2-automate-backup.shの使い方</h2>

<p>拡張子でわかる通り単なるシェルスクリプトで、中ではawscliを駆使して処理を行っている。なので、前提としてawscliがインストールされていて、credentialの設定が終わっている必要がある。awscliのインストール方法については割愛。</p>

<p>awscliの用意が済んだら、リポジトリをクローンしてきてコマンドを叩けばよい。</p>

<p>[code lang=text]</p>

<p>git clone https://github.com/colinbjohnson/aws-missing-tools.git</p>

<p>cd aws-missing-tools/ec2-automate-backup</p>

<p>[/code]</p>

<p>コマンドのオプションは<a href="https://github.com/colinbjohnson/aws-missing-tools/tree/master/ec2-automate-backup">README</a>に書いてあるが、イマイチわかりにくい。最低限以下がわかればとりあえずのバックアップは取れる。</p>

<ul>
  <li><code class="highlighter-rouge">-s [volumeid|tag]</code> : バックアップ対象のボリュームをボリュームID指定するか、特定のタグが付いているもので指定するかを選択する。tagを選んでおくと、例えば「Backup=true」と付いているボリュームを一括でバックアップする、ということが可能。</li>
  <li><code class="highlighter-rouge">-v ボリュームID</code> : <code class="highlighter-rouge">-s volumeid</code>を指定した場合にボリュームIDを指定する。</li>
  <li><code class="highlighter-rouge">-t 'タグ名,Values=値'</code> : <code class="highlighter-rouge">-s tag</code>を指定した場合にタグ名を指定する。上の例のように「Backup=true」のタグが付いているボリュームをバックアップする場合、<code class="highlighter-rouge">-t 'Backup,Values=true'</code>と指定する。ここちょっとわかりにくい。なお、<em>タグはEC2インスタンスではなくEBSボリュームに付ける</em>。</li>
  <li><code class="highlighter-rouge">-r リージョン</code> : リージョン指定。ap-northeast-1とか。</li>
  <li><code class="highlighter-rouge">-n</code> : タグ指定でスナップショットを取った時、スナップショットのNameタグに、元のボリュームIDを入れる</li>
  <li><code class="highlighter-rouge">-k 日数</code> : 指定した日数以上経過したスナップショットは削除可能タグが付けられる</li>
  <li><code class="highlighter-rouge">-p</code> : <code class="highlighter-rouge">-k</code>で指定した日数以上経過したスナップショットを実際に削除する</li>
</ul>

<p>具体的には、以下のようにコマンドを実行する。これは「Backup=trueタグが付いたボリュームのスナップショットを作成し、7日以上経過したスナップショットを削除する」例。</p>

<p>[code lang=text]</p>

<p>bash ec2-automate-backup.sh -s tag -t ‘Backup,Values=true’ -r ap-northeast-1 -n -k 7 -p</p>

<p>[/code]</p>

<p>実際の挙動的には、<code class="highlighter-rouge">-k 7</code>オプションがあるので7日経つとスナップショットにPurgeAllow=trueタグが付けられ、次の実行で<code class="highlighter-rouge">-p</code>オプションが効いてPurgeAllow=trueがついているスナップショットが消される、という流れになる。</p>

<p>これをcrontabに書いておくなりJenkinsで定期実行するなりしておけば、うっかりファイルを消してしまったとか、データベースがぶっ壊れたみたいな時にもサクッと戻せて幸せになれる。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/misc/my-twitter-bots/">
          Twitterボットを作るのがひそかな趣味
          <small><time datetime="2015-05-22T06:26:26-07:00">22 May 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/uncategorized/sql-performance-explained-ja/">
          「SQLパフォーマンス詳解」という本を翻訳しました
          <small><time datetime="2015-04-07T01:45:15-07:00">07 Apr 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/mysql/mysql-casual-talks-7/">
          MySQL Casual Talks Vol. 7まとめ
          <small><time datetime="2014-12-15T01:11:16-08:00">15 Dec 2014</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T11:15:44-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
