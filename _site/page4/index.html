<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      渋谷ではたらくインフラエンジニアのブログ &middot; 
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/mysql/mysql-cluster-casual-talks-memo/">
        MySQL Cluster Casual Talksメモ
      </a>
    </h1>

    <time datetime="2013-09-27T02:25:33-07:00" class="post-date">27 Sep 2013</time>

    <p><strong><a href="http://atnd.org/events/42911" target="_blank">MySQL Cluster Casual Talks</a></strong></p>

<p>一応仕事でMySQLをよく触っている身として、軽く検証はしてみたものの、担当している業務では参照メインのDBが多いこともあって実運用では使ったことがなかったMySQL Cluster。改めて利点も欠点も聞いておきたいと思ったのと、会社からすぐ近くのGMOさんが会場ということもあって参加してみた。</p>

<p>MySQL Clusterの本も書かれている@nippondanjiこと奥野さんから、MySQL Clusterは何に向いていて、どう使えばよさを引き出せるのかを聞いたうえで、そのサポートを受けながら4年間運用されている@tsakuradaさんの実運用上のハマりどころを聞くことで、どういうところにMySQL Clusterを使えばいいのかイメージが浮かんだので、非常に今後の役に立ちそう。</p>

<p>発表者のみなさま、会場提供していただいたGMOのみなさまありがとうございましたm(__)m さくらのクラウド2万円分クーポンももらったし、GMOクラウドのキャラクタのシールもたくさんもらったので宣伝しますｗ</p>

<p>既にまとめは<a href="http://twitter.com/76whizkidz" target="_blank">garage-kid</a>さんが<a href="http://d.hatena.ne.jp/garage-kid/20130926/mysqlclustercasualtalks" target="_blank">書いてくれている</a>ので、これは個人的なポイントのまとめ。</p>

<h2 id="a-hrefhttptwittercomrkajiyama-targetblankrkajiyamaa-mysql-cluster5656"><a href="http://twitter.com/RKajiyama" target="_blank">@RKajiyama</a>さん MySQL Cluster大地に立つ！「5.6とは違うのだよ、5.6とは！」</h2>

<ul>
  <li>MySQL Clusterの概要
    <ul>
      <li>分散型、共有ディスク不要のHAクラスタ</li>
    </ul>
  </li>
  <li>使用しているユーザ
    <ul>
      <li>元々はモバイル通信の位置情報をリアルタイムかつ高可用性を持って保存するためにできた</li>
      <li>SQLインタフェースは昨今ゲーム業界などで使われ始めてから追加されてきた機能</li>
      <li>艦○れでも使われている？</li>
    </ul>
  </li>
</ul>

<h2 id="a-hrefhttptwittercomnippondanji-targetblanknippondanjia-mysql-cluster"><a href="http://twitter.com/nippondanji" target="_blank">@nippondanji</a>さん カジュアルにMySQL Clusterを使ってみよう</h2>

<div style="margin-bottom:5px">
  <strong> <a href="https://www.slideshare.net/nippondanji/mcct" title="カジュアルにMySQL Clusterを使ってみよう@MySQL Cluster Casual Talks 2013.09" target="_blank">カジュアルにMySQL Clusterを使ってみよう@MySQL Cluster Casual Talks 2013.09</a> </strong> from <strong><a href="http://www.slideshare.net/nippondanji" target="_blank">Mikiya Okuno</a></strong>
</div>

<p>データノード、SQLノード、管理ノードの3種類からなる</p>

<ul>
  <li>1台だけならndb(MySQL Clusterのエンジン)よりInnoDBの方が速い</li>
  <li>ただしNDB APIを使うならClusterの方が圧倒的に速い</li>
  <li>ノードを増やすとスケールしていく点に優位性があるが、いつでも速くなるとは限らない(後述)</li>
  <li>新しいバージョン使いましょう</li>
</ul>

<p>シェアードナッシング型</p>

<ul>
  <li>データノードは2台ペアでノードグループを構成</li>
  <li>データをフラグメントに分けて、それをノードグループ内で同期レプリする</li>
  <li>RAID10的な感じでグループ内で1台落ちてもデータは保全される</li>
</ul>

<p>InnoDBとは特性が違う &amp; いつでもノードを増やせばスケールするとは限らない</p>

<ul>
  <li>主キーを使った検索 → データノード数に応じてスケール</li>
  <li><strong>(少数の行を取ってくる)スキャンは苦手</strong>
    <ul>
      <li>データがノードに分散しているので複数ノードをスキャンする必要があるため</li>
      <li>フェッチするレコードが多いと並列処理できるので早くなる</li>
      <li>Engine Condition Pushdown : where句部分を丸ごとデータノードに渡して並列処理して高速化する仕組み</li>
      <li>sysbenchをただ走らせると遅いのはこのせい</li>
    </ul>
  </li>
  <li>ユーザ定義パーティション
    <ul>
      <li>スキャンを高速化させる仕組み</li>
      <li>2つのテーブルの関連を考慮してデータノードへの分散を定義すれば、読み書きを特定のノードに抑えられるので高速に</li>
    </ul>
  </li>
  <li>レプリケーション
    <ul>
      <li><strong>ndbに不得意な処理があるならInnoDB</strong>のスレーブを作るという手もある</li>
      <li>データノードが書き込みしたことをSQLノードに通知し、それをbinlogに書き込んでスレーブに送るという仕組み</li>
      <li>通知を受け取るのがbinlog injector thread</li>
    </ul>
  </li>
  <li><strong>インメモリDBだけど永続化処理が多いのでディスク書き込み多い＝速いディスクがいい</strong></li>
  <li><strong>blobを別テーブルに保存するのでJOIN的処理が発生して遅くなる</strong>
    <ul>
      <li>varcharで頑張ろう</li>
    </ul>
  </li>
  <li>NoSQLインタフェースを使えば爆速
    <ul>
      <li>各種言語のインタフェースあり</li>
      <li>InnoDBのmemcachedインタフェースよりMySQL Clusterの方が現時点では賢い</li>
    </ul>
  </li>
</ul>

<p>まとめ(MySQL Clusterの使いどころ)</p>

<ul>
  <li>大量の更新をさばきたい</li>
  <li>HA機能が欲しい</li>
  <li>高速JOINしたい</li>
</ul>

<h2 id="a-hrefhttptwittercomtsakurada-targetblanktsakuradaa-mysql-clusterversion-73"><a href="http://twitter.com/tsakurada" target="_blank">@tsakurada</a>さん MySQL Clusterと丸４年の付き合いを振り返ってのよもやま話と、Version 7.3への期待（もっとユーザが増えるといいな～）</h2>

<div style="margin-bottom: 5px;">
  <strong> <a title="MCCT20130926 tsakuradac" href="https://www.slideshare.net/TakeshiSakurada/mcct20130926-tsakuradac" target="_blank">MCCT20130926 tsakuradac</a> </strong> from <strong><a href="http://www.slideshare.net/TakeshiSakurada" target="_blank">Takeshi Sakurada</a></strong>
</div>

<p>使用開始時の期待と使ってみたギャップ、現在の期待</p>

<ul>
  <li>インメモリだから速いはず
    <ul>
      <li><strong>参照に関していえばFIO+InnoDBでも変わらないかも</strong></li>
    </ul>
  </li>
  <li>スケールアウト簡単
    <ul>
      <li><strong>構成によってはスケールしない</strong>こともあるので要考慮</li>
    </ul>
  </li>
  <li>高可用性
    <ul>
      <li>期待通り、フェイルオーバーは数秒で完了</li>
    </ul>
  </li>
  <li>ライセンスがGPLでオープンソース</li>
  <li>7.3でInnoとの互換性が上がって期待</li>
</ul>

<p>サーバの構成</p>

<ul>
  <li>SQLノードと管理ノードは同居してもよい、データノード2台と合わせて最低4台からが現実的</li>
  <li>データが多いならデータノードを増やす(が制約はあるので注意)</li>
  <li>アクセスが多いならSQLノードを増やす。制約は少ないので割と簡単</li>
  <li>せっかくのMySQL ClusterなんだからHW構成上もSPOFを減らそう</li>
  <li><strong>クエリがキャンセルされた時それを検出して後続処理をやるアプリ作り込み必須</strong>
    <ul>
      <li>ノード障害時にクエリがキャンセルされるため</li>
    </ul>
  </li>
</ul>

<p>InnoDBとの組み合わせ</p>

<ul>
  <li>Innoと同じ感覚でテーブル設計してもよいか？
    <ul>
      <li>場合による。最近のバージョンではやってみる価値あり</li>
    </ul>
  </li>
  <li>InnoDBスレーブとの組み合わせ
    <ul>
      <li>分離レベルが違う点は要注意だがおおむね問題なし</li>
    </ul>
  </li>
</ul>

<p>ハマりどころ(資料が詳しいのでそちら参照)</p>

<ul>
  <li>GCP Stop</li>
  <li>ローリングリスタート</li>
  <li>ボトルネックが見えづらい</li>
  <li>データのライフサイクルを考えよう</li>
  <li>リストアが大変</li>
</ul>

<p>4年間でだいぶ地雷を踏んだのでもう大丈夫ｗ 皆さんMySQL Cluster使いましょう</p>

<h2 id="a-hrefhttptwittercomyyamasaki1-targetblankyyamasaki1a-mysql-cluster-auto-installer"><a href="http://twitter.com/yyamasaki1" target="_blank">@yyamasaki1</a>さん MySQL Cluster Auto-Installerのデモ</h2>

<div style="margin-bottom:5px">
  <strong> <a href="https://www.slideshare.net/yoyamasaki/5mysql-cluster" title="5分で作るMySQL Cluster環境" target="_blank">5分で作るMySQL Cluster環境</a> </strong> from <strong><a href="http://www.slideshare.net/yoyamasaki" target="_blank">yoyamasaki</a></strong>
</div>

<p>Auto-Installer簡単なので使いましょう</p>

<ul>
  <li>ブラウザベースでぽちぽちやればインストール可能</li>
  <li>初期パラメータをいくつかいじった方がいい</li>
</ul>

<h2 id="a-hrefhttptwittercomyoku0825-targetblankyoku0825a-ndbcluster"><a href="http://twitter.com/yoku0825" target="_blank">@yoku0825</a>さん ウチがNDBCLUSTERを使わない理由をもう一度考える</h2>

<p>MySQL Clusterというと紛らわしいので、NDB Clusterと言いましょう&lt;table border=0&gt;</p>

<p>&lt;/table&gt;</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/nagios/pynag-introduction/">
        Nagiosのプラグイン作成や設定ファイル操作にpynagが超便利！
      </a>
    </h1>

    <time datetime="2013-06-12T02:51:05-07:00" class="post-date">12 Jun 2013</time>

    <p>Nagiosの設定ファイルをパースする簡単な方法ないかなと思って調べてたら、<a href="http://pynag.org/" title="pynag.org" target="_blank">pynag</a>という超便利なパッケージ発見。日本語の情報ほとんどないけど、Fedoraの標準パッケージになっているってことは割と一般的なんだろうか。</p>

<ul>
  <li>Nagiosのプラグインを簡単に作りたい</li>
  <li>Nagiosの設定ファイルをパースして値を取りたい</li>
  <li>Nagiosの設定をコマンドラインやプログラムから取得・変更したい</li>
</ul>

<p>って時に重宝する。pynagという名の通り、pythonで書かれている。公式ページのそのまんま訳に近いけど、使い方ご紹介。</p>

<h2 id="section">インストール</h2>

<p>Fedoraの最近のバージョンには標準で含まれており、CentOSやRHELならepelを使えるようにしておけばyumでインストールできる。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo yum install http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm
  
$ sudo yum install pynag
  
</code></pre>
</div>

<p>pipが使えるならpipでもインストールできる。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo pip install pynag
  
</code></pre>
</div>

<h2 id="section-1">設定ファイルのパース</h2>

<p>pynagパッケージのModelモジュールを使えば、 /etc/nagios など代表的なパスから nagios.cfg を探し出して読み込んでくれる。含まれるホストとそのホストに関連づいたContact groupを表示する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
from pynag import Model

# Get all hosts
  
all_hosts = Model.Host.objects.all
  
for i in all_hosts:
      
print i.host_name, i.contact_groups
  
</code></pre>
</div>

<h2 id="section-2">設定書き換え</h2>

<p>同じようにして、設定を保存することもできる。ホスト名がexamplehostのホストのContact groupを「mycontactgroup」にする例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
from pynag import Model

services = Model.Service.objects.filter(host_name='examplehost')
  
for i in services:
    
i.contactgroups = "mycontactgroup"
    
i.save()
  
</code></pre>
</div>

<h2 id="section-3">ステータスの取得</h2>

<p>監視結果が保存されているstatus.datファイルのパースもしてくれるので、ホストやサービスのステータス取得もできる。</p>

<p>ホストグループ名とサービス名を引数に与えてやると、ホストグループに所属するホスト全てに関するサービスのステータスを返すスクリプト。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
import sys
  
from pynag import Model
  
from pynag.Parsers import status

argvs = sys.argv
  
argc = len(argvs)
  
status = status()

if (argc != 3):
          
print
          
print("Usage: ./%s hostgroup service" % argvs[0])
          
print
          
sys.exit()

hostgroups = Model.Hostgroup.objects.filter(hostgroup_name=argvs[1])
  
for hostgroup in hostgroups:
          
print("Hostgroup: %s" % hostgroup.hostgroup_name)
          
print("Member:")
          
for host in hostgroup.members.split(','):
                  
print("%s %s" % (host, status.get_servicestatus(host, argvs[2])['current_state']))
  
</code></pre>
</div>

<p>status.datのパースにはやや時間がかかるので、監視対象サーバの台数が多いと使用に耐えない。そういう場合は、高速にステータスを取得できる<a href="http://mathias-kettner.de/checkmk_livestatus.html" title="MK Livestatus" target="_blank">MK Livestatus</a>と組み合わせることもできる。インストール方法は割愛するのでWebページを参照するべし。MK Livestatusを使って、上のスクリプトと同じようにホストグループとサービス名を引数に与えてホストのステータスを取得する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
import sys
  
from pynag import Model
  
from pynag.Parsers import mk_livestatus

argvs = sys.argv
  
argc = len(argvs)
  
livestatus = mk_livestatus()

if (argc != 3):
          
print
          
print("Usage: ./%s hostgroup service" % argvs[0])
          
print
          
sys.exit()

hostgroups = Model.Hostgroup.objects.filter(hostgroup_name=argvs[1])
  
for hostgroup in hostgroups:
          
print("Hostgroup: %s" % hostgroup.hostgroup_name)
          
print("Member:")
          
for host in hostgroup.members.split(','):
                  
print(host)
                  
print(livestatus.get_service(host,argvs[2])['host_services_with_info'])
  
</code></pre>
</div>

<h2 id="section-4">コマンドラインから使う</h2>

<p>Pythonのスクリプト内だけでなく、pynagコマンドとしてシェルから直接使うこともできる。where句で対象を絞ることが可能。</p>

<p>全ホストオブジェクトを表示する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ pynag list where object_type=host
  
object_type shortname filename
  
——————————————————————————-
  
host server01 /etc/nagios/Default_collector/hosts.cfg
  
host server02 /etc/nagios/Default_collector/hosts.cfg
  
(中略)
  
———-123 objects matches search condition———————————-
  
</code></pre>
</div>

<p>MySQL_Connect_cというサービスのチェックコマンドを表示する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ pynag list effective_command_line where service_description=MySQL_Connect_c
  
effective_command_line
  
——————————————————————————-
  
/usr/lib64/nagios/plugins/check_mysql_health -hostname -user nagios -password nagios -mode connection-time -database test -critical 1
  
———-1 objects matches search condition————————————
  
</code></pre>
</div>

<p>もちろんコマンドラインから設定の変更も可能。ホスト名server01をserver02に変更する例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ pynag update set host_name=server02 where host_name=server01 and object_type=host
  
</code></pre>
</div>

<p>where句にはlikeのような部分一致が使えないようだ。複雑なクエリを発行したいときは、pythonスクリプトとして作った方がいいかもしれない。コマンドラインでの使い方は<a href="https://github.com/pynag/pynag/wiki/Pynag-command-line-utility" title="pynag wiki" target="_blank">Wiki</a>にもう少し詳しく書いてある。</p>

<h2 id="nagios">Nagiosプラグイン作成時に使う</h2>

<p>個人的に一番ツボなのがこの機能。自作のプラグインに、Nagiosのプラグインを書く際のガイドラインに準じた引数の処理などを簡単に加えることができる。</p>

<p>/proc/loadavgの中身から、ロードアベレージを引いてくる簡単な例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
<span class="c">#!/usr/bin/python</span>
  
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>

<span class="c">## プラグインのオプションを生成</span>
  
<span class="n">np</span> <span class="o">=</span> <span class="n">Plugin</span><span class="p">()</span>

<span class="c">## コマンドライン引数を追加</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_arg</span><span class="p">(</span><span class="s">"l"</span><span class="p">,</span><span class="s">"load-file"</span><span class="p">,</span> <span class="s">"Enter a load average file"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="c">## プラグインをアクティベート</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

<span class="c">## load-fileオプションが指定されたらそのファイルからLAを読み込む</span>
  
<span class="c">## デバッグと、add_argメソッドのサンプルとして</span>
  
<span class="k">if</span> <span class="n">np</span><span class="p">[</span><span class="s">'load-file'</span><span class="p">]:</span>
      
<span class="n">load_file</span> <span class="o">=</span> <span class="n">np</span><span class="p">[</span><span class="s">'load-file'</span><span class="p">]</span>
  
<span class="k">else</span><span class="p">:</span>
      
<span class="n">load_file</span> <span class="o">=</span> <span class="s">"/proc/loadavg"</span>

<span class="c">## ちょっとしたエラーチェック</span>
  
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">load_file</span><span class="p">):</span>
      
<span class="n">np</span><span class="o">.</span><span class="n">nagios_exit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">,</span> <span class="s">"Missing Load average file </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">load_file</span><span class="p">)</span>

<span class="c">## チェックに使う値を取得</span>
  
<span class="n">current_load</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">"cat </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">load_file</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="c">## パフォーマンスデータを付加</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_perfdata</span><span class="p">(</span><span class="s">"1min"</span><span class="p">,</span> <span class="n">current_load</span><span class="p">)</span>

<span class="c">## チェック実行</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">check_range</span><span class="p">(</span><span class="n">current_load</span><span class="p">)</span>
  
</code></pre>
</div>

<p>上のスクリプトをcheck_cpu.pyとして保存しておく。5行目のPlugin()で、プラグインとして必要なオプションが用意されるので、以下のようにスクリプトに引数を指定しないで実行しただけで、簡易ヘルプが表示される。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ ./check_load.py
  
usage: check_load.py [options]

check_load.py: error: You must provide a WARNING and/or CRITICAL value
  
</code></pre>
</div>

<p>さらに、-hオプションをつけると、詳細なヘルプが表示される。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ ./check_load.py -h
  
usage: check_load.py [options]

options:
    
-h, -help show this help message and exit
    
-l LOAD-FILE, -load-file=LOAD-FILE
                          
Enter a load average file
    
-v VERBOSE, -verbose=VERBOSE
                          
Verbosity Level
    
-H HOST, -host=HOST Target Host
    
-t TIMEOUT, -timeout=TIMEOUT
                          
Connection Timeout
    
-c CRITICAL, -critical=CRITICAL
                          
Critical Threshhold
    
-w WARNING, -warning=WARNING
                          
Warn Threshhold
  
</code></pre>
</div>

<p>ここで、スクリプト内の8行目、add_argメソッドで追加したオプションが、ヘルプの中に「-l LOAD-FILE, -load-file=LOAD-FILE」として表示されている。また、-Hでの監視対象ホスト指定や-c,-wによる閾値の指定オプションがはじめから用意されていることがわかる。自作スクリプトを書くたびにオプションのパースから書いていた事を考えれば、なんという簡単さ！</p>

<p>もちろん、ヘルプでみたとおりのオプションを与えてやれば、プラグインとして使用可能。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ uptime
   
13:16:19 up 396 days, 22:32, 3 users, load average: 0.60, 1.08, 1.04

$ ./check_load.py -w 1 127.0.0.1
  
OK: 0.60 is inside warning=1 and critical=None | '1min'=0.60;;;;
  
</code></pre>
</div>

<p>元々やりたかったのは「同一ホストグループ内のある台数のチェック失敗まではWARNING、その台数以上のチェック失敗でCRITICALアラートを上げたい」ということだったのだが、以下のような短いプラグインスクリプトで実現できた。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
<span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">sys</span>
  
<span class="kn">from</span> <span class="nn">pynag</span> <span class="kn">import</span> <span class="n">Model</span>
  
<span class="kn">from</span> <span class="nn">pynag.Parsers</span> <span class="kn">import</span> <span class="n">status</span>
  
<span class="kn">from</span> <span class="nn">pynag.Plugins</span> <span class="kn">import</span> <span class="n">simple</span> <span class="k">as</span> <span class="n">Plugin</span>

<span class="n">np</span> <span class="o">=</span> <span class="n">Plugin</span><span class="p">()</span>
  
<span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">()</span>

<span class="n">np</span><span class="o">.</span><span class="n">add_arg</span><span class="p">(</span><span class="s">"g"</span><span class="p">,</span> <span class="s">"hostgroup"</span><span class="p">,</span> <span class="s">"Hostgroup name"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_arg</span><span class="p">(</span><span class="s">"s"</span><span class="p">,</span> <span class="s">"service"</span><span class="p">,</span> <span class="s">"Service name"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

<span class="n">errornum</span> <span class="o">=</span> <span class="mi">0</span>
  
<span class="n">hostgroups</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">Hostgroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">hostgroup_name</span><span class="o">=</span><span class="n">np</span><span class="p">[</span><span class="s">'hostgroup'</span><span class="p">])</span>
  
<span class="k">for</span> <span class="n">hostgroup</span> <span class="ow">in</span> <span class="n">hostgroups</span><span class="p">:</span>
          
<span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hostgroup</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">):</span>
                  
<span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get_servicestatus</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">np</span><span class="p">[</span><span class="s">'service'</span><span class="p">])[</span><span class="s">'current_state'</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"0"</span><span class="p">:</span>
                          
<span class="n">errornum</span> <span class="o">=</span> <span class="n">errornum</span> <span class="o">+</span> <span class="mi">1</span>
  
<span class="n">np</span><span class="o">.</span><span class="n">add_perfdata</span><span class="p">(</span><span class="s">"WARN/CRIT"</span><span class="p">,</span> <span class="n">errornum</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">check_range</span><span class="p">(</span><span class="n">errornum</span><span class="p">)</span>
  
</code></pre>
</div>

<p>2台のチェックに失敗している時の例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
# 2より多いとwarn、3より多いとcrit
  
$ python check_wipeout.py -hostgroup=common_dbs -service=ifSpeed_eth0_w -w 2 -c 3
  
OK: 2 is inside warning=2 and critical=3 | 'WARN/CRIT'=2;;;;

$ echo $?
  


# 1より多いとwarn、3より多いとcrit
  
$ python check_wipeout.py -hostgroup=common_dbs -service=ifSpeed_eth0_w -w 1 -c 3
  
WARNING: 2 is outside warning range: 1 | 'WARN/CRIT'=2;;;;

$ echo $?
  
1

# 1より多いとcrit
  
$ python check_wipeout.py -hostgroup=common_dbs -service=ifSpeed_eth0_w -c 1
  
CRITICAL: 2 is outside critical range: 1 | 'WARN/CRIT'=2;;;;
  
$ echo $?
  
2
  
</code></pre>
</div>

<p>というわけで、pynagがあるとNagiosプラグインを書くのが超簡単になる！ pynag万歳！</p>

<p>ドキュメントは<a href="https://github.com/pynag/pynag/wiki" title="pynag wiki" target="_blank">Github上のWiki</a>を見るとよい。Wikiからだと分からない部分も多いが、<a href="https://github.com/pynag/pynag" title="pynag" target="_blank">ソース自体</a>はそれほど複雑ではないので読んでみればわかるのでは。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/nagios/setup-nconf/">
        Nagiosの設定ファイル生成ツールnconfが使いやすいのであーる
      </a>
    </h1>

    <time datetime="2013-06-09T08:49:25-07:00" class="post-date">09 Jun 2013</time>

    <p>Nagiosの設定ファイルを編集するツールには、<a title="NagiosQL" href="http://www.nagiosql.org/" target="_blank">NagiosQL</a>など<a title="Nagios Config Tools" href="http://www.nagios.org/projects/nagiosconfigtools" target="_blank">いくつかある</a>が、あれこれ触ってみた感じ<a title="nconf" href="http://www.nconf.org/dokuwiki/doku.php" target="_blank">nconf</a>がよさげだった。JQueryなどを適宜使って動きは軽快だし、メニューの構成などもストレートで直感的に使えるところがNagiosQLよりも気にいった。</p>

<p>監視の設定はできる限り自動生成するくらいが大規模なシステムでは最近の主流かもしれないが、そこまでの大きさのシステムではない時でも、設定ファイルを手で編集するのはいただけない。Nagiosを使うならとりあえずnconfも一緒に入れて設定すべし。</p>

<p>最新版が2011年で開発が活発でないのは気になるが、基本的な機能は網羅されており不自由は感じないので、しばらく使っている。ってことで、CentOS6.4にNagiosとnconfをインストールして、監視を始めるまでの手順。</p>

<h2 id="nagios">Nagiosのインストール</h2>

<p>epelリポジトリにNagiosが含まれているので、epelをインストールしてからNagiosと、監視に使うプラグインをインストール。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo yum install http://ftp-srv2.kddilabs.jp/Linux/distributions/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm
  
$ sudo yum install nagios nagios-plugins
  
</code></pre>
</div>

<p>Nagiosと一緒に、PHPやPerl、Apacheなども一緒にインストールされる。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo /etc/init.d/nagios start
  
$ sudo /etc/init.d/httpd start
  
</code></pre>
</div>

<p>NagiosとApacheを起動したら、 http://(サーバのIP)/nagios をブラウザで開いて、ユーザ名 nagiosadmin、パスワード nagiosadmin でログインするとNagios管理画面が開ければNagiosの準備は一旦終わり。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/Nagios-Core.png" target="_blank"><img class="alignnone  wp-image-1484" style="border: 0px;" alt="Nagios Core" src="http://b.l0g.jp/wp-content/uploads/2013/06/Nagios-Core.png" width="408" height="245" /></a></p>

<h2 id="mysql">MySQLのインストール</h2>

<p>nconfの特徴として、設定をMySQLに入れておいて、そこからNagiosの設定ファイルを生成することが挙げられる。そのためにMySQLをインストール。nconfはPHPで書かれており、PHPからMySQLへ接続するためのphp-mysqlも一緒にインストール。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo yum install mysql-server php-mysql
  
</code></pre>
</div>

<p>mysql, mysql-libsなどもインストールされる。</p>

<p><a href="http://b.l0g.jp/mysql/install-cacti-to-monitor-mysql-1/">この辺</a>参照して、/etc/my.cnf の [mysqld] セクションに最低限の設定をしてから、MySQLを起動。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo /etc/init.d/mysqld start
  
</code></pre>
</div>

<p>nconf用データベースと、MySQLへ接続するためのアカウントも作成。以下の例では、データベース名がnconf、ユーザ名がnconf、パスワードはnconfpasswordとしているが、任意のものにできるので適宜変更すべし。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ mysql -uroot
  
mysql&gt; create database nconf;
  
Query OK, 1 row affected (0.00 sec)

mysql&gt; grant SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, DROP on nconf.* to 'nconf'@'localhost' identified by 'nconfpassword';
  
Query OK, 0 rows affected (0.00 sec)
  
</code></pre>
</div>

<h2 id="nconf">nconfのインストール</h2>

<p><a href="http://www.nconf.org/">nconfのサイト</a>のDownloadからnconf-1.3.0-0.tgzをダウンロードして適当なディレクトリに配置。CentOSのApacheのDocumentRootに展開する。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
cd /var/www/html
  
sudo tar zxvf /fuga/hoge/nconf-1.3.0-0.tgz
  
chown -R apache. nconf
  
</code></pre>
</div>

<p>インストールに必要な設定は、GUIで行える。http://(サーバのIP)/nconf/ をブラウザで開く。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf01.png" target="_blank"><img class="alignnone  wp-image-1488" style="border: 0px;" alt="nconf01" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf01.png" width="665" height="430" /></a></p>

<p>ここで画面がforbiddenになる場合、SELinuxが有効になっている可能性がある(/var/log/audit/audit.logにその旨出力されているはずなので確認すべし)。そんな時は頑張って動くように設定するか、そっと/etc/sysconfig/selinuxのSELINUX=enabledをdisabledに書き換えてOSを再起動する。</p>

<p>必須のパッケージが全てインストールされていれば、最初の画面でOKが並ぶので、Nextをクリック。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf02.png" target="_blank"><img class="alignnone  wp-image-1489" style="border: 0px;" alt="nconf02" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf02.png" width="665" height="430" /></a></p>

<p>前項でMySQLに作成したデータベース名とアカウントを入力してNextを押すとチェックが走るので、OKが並んだらNext。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf03.png" target="_blank"><img class="alignnone  wp-image-1490" style="border: 0px;" alt="nconf03" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf03.png" width="665" height="430" /></a></p>

<p>nconfの接続に認証を必要とするかどうかの設定。後でも変更できるので一旦そのまま(AUTH_ENABLEDがFALSE)でNext。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf04.png" target="_blank"><img class="alignnone  wp-image-1491" style="border: 0px;" alt="nconf04" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf04.png" width="665" height="430" /></a></p>

<p>全て完了したらFinishをクリック。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf05.png" target="_blank"><img class="alignnone  wp-image-1492" style="border: 0px;" alt="nconf05" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf05.png" width="665" height="430" /></a></p>

<p>インストールしたディレクトリ内のファイル、ディレクトリを削除しろというメッセージが出るので、リネームする(別に使わないと思うが一応)。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ cd /var/www/html/nconf
  
$ sudo mv INSTALL INSTALL.org
  
$ sudo mv INSTALL.php INSTALL.php.org
  
$ sudo mv UPDATE UPDATE.org
  
$ sudo mv UPDATE.php UPDATE.php.org
  
</code></pre>
</div>

<p>ここまででnconfの設定画面にはアクセスできるようになる。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf07.png" target="_blank"><img class="alignnone  wp-image-1504" style="border: 0px;" alt="nconf07" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf07.png" width="665" height="430" /></a></p>

<h2 id="nconfnagios">nconfの設定・Nagiosの追加設定</h2>

<p>前述の通りnconfはMySQLに設定を書いていて、それをNagiosの設定ファイルとして書き出し、Nagiosを再起動して設定を反映させるところまでnconfでやることができる。そのための追加設定がここから。</p>

<p>/var/www/html/nconf/config/nconf.php (nconfのメイン設定ファイル)を以下の通り書き換え。</p>

<p>23行目。Nagios本体のパスを指定する。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
\# 変更前
  
define('NAGIOS_BIN', '/var/www/html/nconf/bin/nagios');
  
\# 変更後
  
define('NAGIOS_BIN', '/usr/sbin/nagios');
  
</code></pre>
</div>

<p>75行目。Nagiosのメイン設定ファイル(nagios.cfg)の構文チェックを無効化。手元の環境では、有効にしてしまうと、正しいはずの設定ファイルのチェックがどうしてもエラーになってしまったのでやむなく。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
\# 変更前
  
define('CHECK\_STATIC\_SYNTAX', 1);
  
\# 変更後
  
define('CHECK\_STATIC\_SYNTAX', 0);
  
</code></pre>
</div>

<p>80行目。この配列に入っているユーザが、通知先などに自動で追加されてしまうので削除。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
\# 変更前
  
$SUPERADMIN_GROUPS = array ("+admins");
  
\# 変更後
  
$SUPERADMIN_GROUPS = array ("");
  
</code></pre>
</div>

<p>/var/www/html/nconf/config/deployment.ini (nconfの自動デプロイ設定ファイル)を以下の通り書き換え。</p>

<p>「;; LOCAL deployment ;;」の下、6行目から29行目までの以下のセクションの行頭のセミコロンを外して有効化。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
;[extract config]
  
;[copy collector config]
  
;[copy global config]
  
;[copy nagios.cfg]
  
</code></pre>
</div>

<p>また、nconfが生成するNagios設定ファイルのアーカイブを指定する、8行目を以下のとおり変更。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
\# 変更前
  
source_file = "/var/www/nconf/output/NagiosConfig.tgz"
  
\# 変更後
  
source_file = "/var/www/html/nconf/output/NagiosConfig.tgz"
  
</code></pre>
</div>

<p>Apacheの起動ユーザapacheがNagiosを再起動できるようにsudoersを編集。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo visudo
  
</code></pre>
</div>

<p>以下の1行を末尾に追加。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
apache ALL=(ALL)NOPASSWD: /etc/rc.d/init.d/nagios reload
  
</code></pre>
</div>

<p>nconfが生成した設定ファイルをNagiosの設定ファイルディレクトリ(/etc/nagios)に配置できるように細々した設定。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ cd /etc/nagios
  
$ sudo mkdir Default_collector global
  
$ sudo chown apache. Default_collector global nagios.cfg
  
</code></pre>
</div>

<p>nconfからnagios.cfgを編集・配置することもできるので、一応nconfのディレクトリ以下にnagios.cfgを置いておく。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo cp /etc/nagios/nagios.cfg /var/www/html/nconf/static_cfg/
  
</code></pre>
</div>

<p>nconfが配置するファイルを設定ファイルとして使用するように、コピーした先の/var/www/html/nconf/static_cfg/nagios.cfgを編集。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
\# cfg\_fileとcfg\_dirを全てコメントアウトして以下の2行を追加。

cfg_dir=/etc/nagios/global
  
cfg\_dir=/etc/nagios/Default\_collector
  
</code></pre>
</div>

<p>これで設定はおしまい。ApacheとNagiosを再起動して一息つく。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
$ sudo /etc/init.d/httpd stop
  
$ sudo /etc/init.d/nagios restart
  
$ sudo /etc/init.d/httpd start
  
</code></pre>
</div>

<h2 id="section">動作確認</h2>

<p>http://(サーバのIP)/nagios/ を開いて、左側のCurrent Status → Servicesをクリックすると、Nagios側では以下のようにデフォルトでlocalhostの監視のみが設定されている。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nagios02.png" target="_blank"><img class="alignnone  wp-image-1493" style="border: 0px;" alt="nagios02" src="http://b.l0g.jp/wp-content/uploads/2013/06/nagios02.png" width="680" height="409" /></a></p>

<p>一方、 http://(サーバのIP)/nconf/ を開いて、左側のBasic Items → Hostsをクリックすると、nconf側ではlocalhost以外にサンプルとしてhplj2605dnなど合わせて4台分の設定が入っていることが分かる。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf08.png" target="_blank"><img class="alignnone  wp-image-1494" style="border: 0px;" alt="nconf08" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf08.png" width="665" height="430" /></a></p>

<p>ここで、nconfの左側のメニューからBasic Items → Generate Nagios configをクリックすると、設定ファイルが生成される。以下の画面で「Deploy」をクリックする。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf09.png" target="_blank"><img class="alignnone  wp-image-1495" style="border: 0px;" alt="nconf09" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf09.png" width="665" height="430" /></a></p>

<p>以下の画面のように、全てOKになれば、設定ファイルのデプロイとNagiosの再起動が終わっているはず。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nconf10.png" target="_blank"><img class="alignnone  wp-image-1496" style="border: 0px;" alt="nconf10" src="http://b.l0g.jp/wp-content/uploads/2013/06/nconf10.png" width="665" height="430" /></a></p>

<p>ここで、Nagiosの画面を開くと、以下のようにnconfに入っていた設定が有効になって、ホストが増えていれば成功。</p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2013/06/nagios03.png" target="_blank"><img class="alignnone  wp-image-1506" style="border: 0px;" alt="nagios03" src="http://b.l0g.jp/wp-content/uploads/2013/06/nagios03.png" width="680" height="380" /></a></p>

<p>後は、nconfからあれこれ設定を入れて監視を始めるべし。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page5">Older</a>
  
  
    <a class="pagination-item newer" href="/page3">Newer</a>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T11:57:39-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
