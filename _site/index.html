<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      渋谷ではたらくインフラエンジニアのブログ &middot; 
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/aws/periodic-ebs-snapshot/">
        AWSのEBSボリュームのスナップショットを定期的に取る
      </a>
    </h1>

    <time datetime="2015-10-19T06:33:30-07:00" class="post-date">19 Oct 2015</time>

    <p>小ネタだけど、久しぶりに技術的な内容の記事を書いてみる。最近はこういうのはQiitaに書くのが流行り？</p>

<h2 id="ebs">EBSボリュームのスナップショット</h2>

<p>インスタンスストレージ(インスタンスに無料で付いてくるローカルストレージ)と比べてEBSを使うことの利点の一つに、スナップショットを取れるというのがある。これはもちろん<a href="http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html">AWSのコンソールからの操作</a>でも、<a href="https://aws.amazon.com/jp/cli/">awscli</a>のようなツールを使ってもできるんだけど、いちいちこれらの操作をやるのは面倒になってくる。そうすると、</p>

<ul>
  <li>自動で定期的にスナップショットを取りたい</li>
  <li>古いスナップショットは自動的に消したい</li>
  <li>複数のEBSボリュームのスナップショットをまとめて取りたい</li>
  <li>全ボリュームのスナップショットを取る必要はなく、一部だけ取っておきたい</li>
</ul>

<p>みたいな話が出てくる。</p>

<p>そういう時にはもちろんawscliや各言語のSDKを使って自分でこれを実装してもいいのだが、<a href="https://github.com/colinbjohnson/aws-missing-tools">AWS Missing Tools</a>と言う、AWSに関するちょっと痒いところに手が届くツール集があって、これに含まれるEBSスナップショット取得用のスクリプト ec2-automate-backup.sh を使うと便利。</p>

<h2 id="ec2-automate-backupsh">ec2-automate-backup.shの使い方</h2>

<p>拡張子でわかる通り単なるシェルスクリプトで、中ではawscliを駆使して処理を行っている。なので、前提としてawscliがインストールされていて、credentialの設定が終わっている必要がある。awscliのインストール方法については割愛。</p>

<p>awscliの用意が済んだら、リポジトリをクローンしてきてコマンドを叩けばよい。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
git clone https://github.com/colinbjohnson/aws-missing-tools.git
  
cd aws-missing-tools/ec2-automate-backup
  
</code></pre>
</div>

<p>コマンドのオプションは<a href="https://github.com/colinbjohnson/aws-missing-tools/tree/master/ec2-automate-backup">README</a>に書いてあるが、イマイチわかりにくい。最低限以下がわかればとりあえずのバックアップは取れる。</p>

<ul>
  <li><code class="highlighter-rouge">-s [volumeid|tag]</code> : バックアップ対象のボリュームをボリュームID指定するか、特定のタグが付いているもので指定するかを選択する。tagを選んでおくと、例えば「Backup=true」と付いているボリュームを一括でバックアップする、ということが可能。</li>
  <li><code class="highlighter-rouge">-v ボリュームID</code> : <code class="highlighter-rouge">-s volumeid</code>を指定した場合にボリュームIDを指定する。</li>
  <li><code class="highlighter-rouge">-t 'タグ名,Values=値'</code> : <code class="highlighter-rouge">-s tag</code>を指定した場合にタグ名を指定する。上の例のように「Backup=true」のタグが付いているボリュームをバックアップする場合、<code class="highlighter-rouge">-t 'Backup,Values=true'</code>と指定する。ここちょっとわかりにくい。なお、<em>タグはEC2インスタンスではなくEBSボリュームに付ける</em>。</li>
  <li><code class="highlighter-rouge">-r リージョン</code> : リージョン指定。ap-northeast-1とか。</li>
  <li><code class="highlighter-rouge">-n</code> : タグ指定でスナップショットを取った時、スナップショットのNameタグに、元のボリュームIDを入れる</li>
  <li><code class="highlighter-rouge">-k 日数</code> : 指定した日数以上経過したスナップショットは削除可能タグが付けられる</li>
  <li><code class="highlighter-rouge">-p</code> : <code class="highlighter-rouge">-k</code>で指定した日数以上経過したスナップショットを実際に削除する</li>
</ul>

<p>具体的には、以下のようにコマンドを実行する。これは「Backup=trueタグが付いたボリュームのスナップショットを作成し、7日以上経過したスナップショットを削除する」例。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  
bash ec2-automate-backup.sh -s tag -t 'Backup,Values=true' -r ap-northeast-1 -n -k 7 -p
  
</code></pre>
</div>

<p>実際の挙動的には、<code class="highlighter-rouge">-k 7</code>オプションがあるので7日経つとスナップショットにPurgeAllow=trueタグが付けられ、次の実行で<code class="highlighter-rouge">-p</code>オプションが効いてPurgeAllow=trueがついているスナップショットが消される、という流れになる。</p>

<p>これをcrontabに書いておくなりJenkinsで定期実行するなりしておけば、うっかりファイルを消してしまったとか、データベースがぶっ壊れたみたいな時にもサクッと戻せて幸せになれる。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/misc/my-twitter-bots/">
        Twitterボットを作るのがひそかな趣味
      </a>
    </h1>

    <time datetime="2015-05-22T06:26:26-07:00" class="post-date">22 May 2015</time>

    <p> </p>

<p>プログラミングの勉強にと思ってTwitterボットを作ってみたら、ことあるごとに「あっ、これもボットになってたら便利そう」と思うようになってしまって、さらにいくつか作るという流れ。それなりに便利なのができると、ほっといてもフォロワーが増えていくのが楽しくなってしまう。今まで作ったボットのまとめ。</p>

<h1 id="bot-a-hrefhttpstwittercomfukadakyuyabot-targetblankfukadakyuyabota">深田久弥bot  <a href="https://twitter.com/fukadakyuya_bot" target="_blank">@fukadakyuya_bot</a></h1>

<p>TLでフォロワーのみなさまと盛り上がったのがきっかけで、初めて作ったTwitterボット。ボットをフォローしているユーザが深田久弥の著書「<a href="http://www.amazon.co.jp/gp/product/4101220026/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=4101220026&amp;linkCode=as2&amp;tag=l0gjp-22" rel="nofollow">日本百名山 (新潮文庫)</a><img style="border: none !important; margin: 0px !important;" src="http://ir-jp.amazon-adsystem.com/e/ir?t=l0gjp-22&amp;l=as2&amp;o=9&amp;a=4101220026" alt="" width="1" height="1" border="0" />」に含まれる山名を含んだつぶやきをすると、同書の中からその山の特徴などを表した部分をリプライする。また、1日1回7：00にはランダムに抜粋をつぶやく。</p>

<blockquote class="twitter-tweet" lang="ja">
  <p dir="ltr" lang="ja">
    <a href="https://twitter.com/doublemarket">@doublemarket</a> 夕方、日本海に沈む太陽の余映を受けて、白山が薔薇色に染まるひと時は、美しいものの究極であった。みるみるうちに薄鼠に暮れて行くまでの、暫くの間の微妙な色彩の推移は、この世のものとは思われなかった。
  </p>
  
  <p>
    — 深田久弥bot (@fukadakyuya_bot) <a href="https://twitter.com/fukadakyuya_bot/status/493185509611413504">2014, 7月 27</a>
  </p>
</blockquote>

<p>最初はPHPで書いたのだがいつの間にかうまく動かなくなったりして、Rubyで書き換えた。ソースコードは<a href="https://github.com/doublemarket/twitterbot.rb" target="_blank">Githubに上げてある</a>。作った頃はRubyのエコシステムが良く分かってなくて、bundler使わずにやってたりして、自分でもどうやって動いてるのか理解してなかったなあｗ リプライする山名にどういう傾向があるのか気になったので、<a href="http://f.l0g.jp/" target="_blank">山名ごとにリプライ数を集計する仕組み</a>も作ってみた。基本的に富士山がダントツに多いのだが、例えば最近だと吾妻山や蔵王山(火山活動活発化)、立山(アルペンルート開通)といったように、急にリプライ数が増えた山があると、大体そこでは何かあったということが分かって面白い。</p>

<h1 id="a-hrefhttpstwittercomyamatenki-targetblankyamatenkia">山の天気 <a href="https://twitter.com/yamatenki" target="_blank">@yamatenki</a></h1>

<p>毎朝7：30前後に、その週末に天気がいい(登山日和になりそうな)山を地域ごとにツイートする。 土曜と日曜それぞれ分けて判断するようになっている。祝日などの連休にも対応させたいが、めんどくさそうなので先送りしてしまっている。</p>

<blockquote class="twitter-tweet" lang="ja">
  <p>
    【南アルプス】今週末、山に行くなら「甲斐駒ヶ岳」「仙丈岳」「鳳凰山」「北岳」「間ノ岳」、日曜日なら「塩見岳」「悪沢岳」「赤石岳」「聖岳」「光岳」の天気が良いようです。 <a href="http://t.co/YU8l9oRZUo">http://t.co/YU8l9oRZUo</a> — 山の天気 (@yamatenki) <a href="https://twitter.com/yamatenki/status/599341524011372545">2015, 5月 15</a>
  </p>
</blockquote>

<p>山名を含んだメンションを送ると、少し詳しい天気予報をリプライしてくれる。</p>

<blockquote class="twitter-tweet" lang="ja">
  <p dir="ltr" lang="ja">
    <a href="https://twitter.com/doublemarket">@doublemarket</a>【今週末の丹沢山】03/29土曜日は、くもり時々晴れ、降水確率は12時まで30%、18時まで30%。03/30日曜日は、くもり一時雨、降水確率は12時まで50%、18時まで50%。 (神奈川県西部) <a href="http://t.co/0Kh75x9Egg">http://t.co/0Kh75x9Egg</a>
  </p>
  
  <p>
    — 山の天気 (@yamatenki) <a href="https://twitter.com/yamatenki/status/448258476980981760">2014, 3月 25</a>
  </p>
</blockquote>

<p>こちらも最初はPHPで作ったが今はRuby製。<a href="http://t.l0g.jp/" target="_blank">天気が一覧で見れるページ</a>も定期的に生成している。 深田久弥botと違ってうざくない作りなのもあってか、フォロワーが4600以上(2015年5月)もいて、自分の作ったボットの中では一番多い。</p>

<h1 id="hatebu-english-a-hrefhttpstwittercomhatebue-targetblankhatebuea">hatebu english <a href="https://twitter.com/hatebu_e" target="_blank">@hatebu_e</a></h1>

<p>はてなブックマークが一定数以上付いた日本語以外の(正確には、タイトルと本文に全角文字を含まない)記事をツイートする。<a href="http://yakst.com/ja" target="_blank">Yakstという主に英語のブログ記事などを翻訳して公開するサイト</a>を解説しているのだが、そのネタ探しの足しになるかと思って作った。</p>

<blockquote class="twitter-tweet" lang="ja">
  <p>
    GitHub Engineering (3 users) <a href="http://t.co/xWxAkjVCZI">http://t.co/xWxAkjVCZI</a> <a href="http://t.co/aDzjTh7OfY">http://t.co/aDzjTh7OfY</a> — hatebu english (@hatebu_e) <a href="https://twitter.com/hatebu_e/status/600682354470817792">2015, 5月 19</a>
  </p>
</blockquote>

<p>誰得なのかよく分からないボットなので、フォロワーは少ないw</p>

<h1 id="aws-a-hrefhttpstwittercomawsstatusjpall-targetblankawsstatusjpalla">AWS障害情報(全リージョン) <a href="https://twitter.com/awsstatusjp_all" target="_blank">@awsstatusjp_all</a></h1>

<h1 id="aws-a-hrefhttpstwittercomawsstatusjp-targetblankawsstatusjpa">AWS障害情報(東京リージョン) <a href="https://twitter.com/awsstatusjp" target="_blank">@awsstatusjp</a></h1>

<p>仕事でAWSを本格的に使い始めたので、手軽にAWSのステータス情報を知れる手段がないかと思ったのだが、いい感じのボットがなかったので作った。時刻を日本時間に直し、定型的な文言はなるべく日本語に翻訳するようにしている。GCPとかのボットもなければ作ってみようかな。</p>

<blockquote class="twitter-tweet" lang="ja">
  <p lang="ja" dir="ltr">
    日本時間2015年05月19日(火) 07:46:53 EC2 (サンパウロ) お知らせ Network Connectivity <a href="http://t.co/LMkNfK2ZYm">http://t.co/LMkNfK2ZYm</a>
  </p>
  
  <p>
    &mdash; AWS障害情報(全リージョン) (@awsstatusjp_all) <a href="https://twitter.com/awsstatusjp_all/status/600433202222608384">2015, 5月 18</a>
  </p>
</blockquote>

<blockquote class="twitter-tweet" lang="ja">
  <p dir="ltr" lang="ja">
    日本時間2015年05月16日(土) 00:36:27 EC2 (東京) 正常稼働中 [復旧済み] Network connectivity <a href="http://t.co/aq5bOVSJ4H">http://t.co/aq5bOVSJ4H</a>
  </p>
  
  <p>
    — AWS障害情報(東京リージョン) (@awsstatusjp) <a href="https://twitter.com/awsstatusjp/status/599237837637062656">2015, 5月 15</a>
  </p>
</blockquote>

<p>ちなみに、プロジェクトでHipchatやSlackなどのチャットツールを使っている場合、それぞれのTwitter連携機能を使ってこのボットのツイートを拾うようにすれば、AWSの障害情報が流れてくるようになって便利。</p>

<p>ボットを作ると、プログラミングの基礎もだが、Twitter APIやスクレイピングのテクニックなど、作るボットに応じて色々な技術が必要とされるので、新しい言語を覚える人とか、そもそもプログラミング初心者にはもってこいの課題になる。オススメです。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/uncategorized/sql-performance-explained-ja/">
        「SQLパフォーマンス詳解」という本を翻訳しました
      </a>
    </h1>

    <time datetime="2015-04-07T01:45:15-07:00" class="post-date">07 Apr 2015</time>

    <p> </p>

<p><a href="http://b.l0g.jp/wp-content/uploads/2015/04/sqlperformanceexplainedja.png"><img class="alignleft wp-image-1648 size-medium" style="border: 0px;" src="http://b.l0g.jp/wp-content/uploads/2015/04/sqlperformanceexplainedja-196x300.png" alt="sqlperformanceexplainedja" width="196" height="300" /></a>題の通り、「<a title="SQLパフォーマンス詳解" href="http://sql-performance-explained.jp/" target="_blank">SQLパフォーマンス詳解</a>」(原文タイトル<a title="SQL Performance Explained" href="http://sql-performance-explained.com/" target="_blank">SQL Performance Explained</a>)という本を翻訳しました。PDFは既に上記サイトから購入できるようになっていて、印刷されたものは夏以降に提供予定です。</p>

<p>リレーショナルデータベースにおいて、SQLとインデックスがどのように関連し、どのようにすればSQLのパフォーマンスを良くできるのかを解説した本です。特定のデータベース製品に焦点を当てた本は多数ありますが、この本ではOracle Database、PostgreSQL、MySQL、SQL Serverの4つのメジャーなリレーショナルデータベース製品を同時に扱っていて、それぞれのクセや特徴も分かるように書かれている点が非常にユニークになっています。また、ORMが生成するSQL文の違いなどにも言及されています。</p>

<p>前書きにもあるように、データへのアクセスパスを知っているのは他ならぬ開発者なので、開発者自身がSQLとインデックスについての知識を深めなければ本当の高速化はできない、というのが著者の考えのようですが、もちろんアプリ開発者だけでなくインフラエンジニア、データベースエンジニアの方々にもおすすめできる内容だと思います。</p>

<p>目次とそれぞれの内容は以下の通りです。</p>

<ul>
  <li>第1章 インデックスの内部構造
    <ul>
      <li>インデックスとはそもそも何か、インデックスはどのような仕組みか</li>
    </ul>
  </li>
  <li>第2章 where句
    <ul>
      <li>where句とインデックスの関連、例えば=を使った場合、likeを使った場合など演算子の違いによるインデックスの活用方法など</li>
    </ul>
  </li>
  <li>第3章 パフォーマンスとスケーラビリティ
    <ul>
      <li>インデックスの作り方の違いによるパフォーマンスとスケーラビリティの違い</li>
    </ul>
  </li>
  <li>第4章 結合処理
    <ul>
      <li>結合(join)とインデックスの関連</li>
    </ul>
  </li>
  <li>第5章 データのクラスタリング
    <ul>
      <li>データのクラスタリング(HAクラスタなどではなく、いわゆるクラスタリングインデックスのこと)</li>
    </ul>
  </li>
  <li>第6章 ソートとグルーピング
    <ul>
      <li>ソート(order by)やグルーピング(group by)とインデックスの関連</li>
    </ul>
  </li>
  <li>第7章 部分結果
    <ul>
      <li>MySQLで言うlimitやPostgreSQLのfetch firstのような、結果の一部分を取得するSQL文とインデックスの関連</li>
    </ul>
  </li>
  <li>第8章 データの変更
    <ul>
      <li>update, insert, deleteといった更新処理とインデックスの関連</li>
    </ul>
  </li>
  <li>付録A 実行計画
    <ul>
      <li>各データベース製品での実行計画の表示方法とその読み方</li>
    </ul>
  </li>
</ul>

<p>既にご存知の方もいるかもしれませんが、<a title="Use The Index, Luke日本語版" href="http://use-the-index-luke.com/ja/sql/table-of-contents" target="_blank">Use The Index, Luke</a>という名でほぼ全文がWeb上で公開されています。とはいえWeb上で通しで読むのはかなり辛いですし、PDFあるいは印刷版を購入いただければ、作者・訳者とも嬉しい限りです。</p>

<p>私は、<a title="Yakst" href="http://yakst.com/ja" target="_blank">Yakst</a>というサイトで海外のブログ記事などを翻訳して公開するというのをやっているのですが、原著者(<a title="Markus Winand" href="https://twitter.com/markuswinand" target="_blank">Markus Winandさん</a>)が書かれた<a title="Yakst - SQLに対するMySQLと、NoSQLに対するMongoDBは似ている――主に有害な意味で" href="http://yakst.com/ja/posts/74" target="_blank">ブログ記事を翻訳させてもらった</a>のがきっかけで、この本の翻訳をやることになりました。オンライン販売だけの予定なので書店に本が並ぶわけではないとは言え、自分が訳した本が人に読まれることになるというのは、不思議な感覚です。Markusさんはオーストリア人で英語のネイティブスピーカーではないこともあり、原文は非常に分かりやすい英語で書かれているのですが、それでも翻訳の難しさ、自分の未熟さをひしひしと感じました。素晴らしい本を書いてくださった原著者のMarkusさん、私のつたない訳を丁寧にレビューしてくださった<a title="matsuu" href="https://twitter.com/matsuu" target="_blank">@matsuu</a>さん、ありがとうございました！</p>

<p>訳の問題など、ご意見ご感想ありましたら<a title="doublemarket" href="https://twitter.com/dblmkt" target="_blank">@dblmkt</a>までいつでもご連絡ください。</p>

<p>ちなみに、海外の有益な技術系ブログを翻訳して公開している<a title="Yakst" href="http://yakst.com/ja" target="_blank">Yakst</a>で、翻訳を一緒にやっていただける仲間も募集しておりますので、良かったらそちらも是非よろしくお願いします。</p>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T11:57:39-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
