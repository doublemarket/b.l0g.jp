<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      symfonyでデータをMySQLにロードする際のduplicate entryエラー &middot; 渋谷ではたらくインフラエンジニアのブログ
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="渋谷ではたらくインフラエンジニアのブログ" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">渋谷ではたらくインフラエンジニアのブログ</a>
          <small></small>
        </h3>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">symfonyでデータをMySQLにロードする際のduplicate entryエラー</h1>
  <time datetime="2010-08-05T02:47:49-07:00" class="post-date">05 Aug 2010</time>
  <p>symfony 1.4.6 + XAMPP 1.7.3(Windows)で、ありがちなエラーではまったので、メモ。</p>

<div id="_mcePaste">
  symfonyのschema.ymlとfixture.ymlを記述して、
</div>

<blockquote>
  <div>
  # symfony doctrine:build &#8211;all &#8211;and-load &#8211;no-confirmation
</div>
</blockquote>

<div id="_mcePaste">
  で、一気にデータベースの再構築とデータのロードを行おうとしたところ、以下のエラー発生。
</div>

<blockquote>
  <div id="_mcePaste">
  &gt;&gt; doctrine  created tables successfully
</div>

  <div id="_mcePaste">
  &gt;&gt; doctrine  Loading data fixtures from &#8220;C:\&#8230;\Eclipse\symfony\data/fixtures&#8221;
</div>

  <div id="_mcePaste">
  &gt;&gt; doctrine  Loading data fixtures from &#8220;C:/&#8230;trineGuardPlugin/data/fixtures&#8221;
</div>

  <div id="_mcePaste">
  SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry &#8216;????&#8217; for key &#8216;name&#8217;
</div>
</blockquote>

<div id="_mcePaste">
  当たり前だが、fixture.ymlでは重複するような値を定義してはいない。????というのが気になるが、これは何？
</div>

<div id="_mcePaste">
  どうやらこれは、データベースの文字コードがlatin1などになっている場合に起きるようである。データベースの文字コードをUTF-8にすると共に、fixture.ymlに日本語のキーが含まれている場合、こちらの文字コードもUTF-8にする(Windowsではメモ帳などを使って編集すると普通Shift-JISになるので注意)。
</div>

<blockquote>
  <div id="_mcePaste">
  [mysqld]
</div>

  <div id="_mcePaste">
  default-character-set=utf8
</div>

  <div id="_mcePaste">
  character_set_server=utf8
</div>

  <div id="_mcePaste">
  skip-character-set-client-handshake
</div>

  <div id="_mcePaste">
  [mysql]
</div>

  <div id="_mcePaste">
  default-character-set=utf8
</div>
</blockquote>

<div id="_mcePaste">
  XAMPPのインストールフォルダ以下、mysql\bin\my.ini ファイル内の各項目に、上記を追記し、
</div>

<blockquote>
  <div id="_mcePaste">
  net stop mysql   # MySQLサービス停止
</div>

  <div id="_mcePaste">
  net start mysql  # MySQLサービス開始
</div>

  <div id="_mcePaste">
  mysql -uroot -p パスワード
</div>

  <div id="_mcePaste">
  mysql&gt; drop database データベース名;   # 念のためDB削除
</div>

  <div id="_mcePaste">
  mysql&gt; create database データベース名;   # 念のためDB再作成
</div>
</blockquote>

<div id="_mcePaste">
  としてMySQL再起動、データベース再作成をしてからもう一度
</div>

<blockquote>
  <div id="_mcePaste">
  # symfony doctrine:build &#8211;all &#8211;and-load &#8211;no-confirmation
</div>
</blockquote>

<div id="_mcePaste">
  とすれば、すんなりデータベースを作成できる。
</div>

<div id="_mcePaste">
  なお、自分がやったときには、MySQLのstatusコマンドではUTF-8になっていたのに、どうしても上記のDuplicate entryのエラーが出てしまい、混乱した。
</div>

<blockquote>
  <div id="_mcePaste">
  mysql  Ver 14.14 Distrib 5.1.41, for Win32 (ia32)
</div>

  <div id="_mcePaste">
  Connection id:          5
</div>

  <div id="_mcePaste">
  SSL:                    Not in use
</div>

  <div id="_mcePaste">
  Using delimiter:        ;
</div>

  <div id="_mcePaste">
  Server version:         5.1.41 Source distribution
</div>

  <div id="_mcePaste">
  Protocol version:       10
</div>

  <div id="_mcePaste">
  Connection:             Named pipe: MySQL
</div>

  <div id="_mcePaste">
  Client characterset:    UTF-8
</div>

  <div id="_mcePaste">
  Server characterset:    UTF-8
</div>

  <div id="_mcePaste">
  UNIX socket:            MySQL
</div>

  <div id="_mcePaste">
  Uptime:                 9 min 40 sec
</div>
</blockquote>

<div id="_mcePaste">
  この場合、以下のコマンドでも確認し、全部の設定がUTF-8に揃っているかを見てみるべし。
</div>

<blockquote>
  <div id="_mcePaste">
  mysql&gt; show variables like &#8216;char%&#8217;;
</div>

  <div id="_mcePaste">
  +&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-+
</div>

  <div id="_mcePaste">
  | Variable_name            | Value                                  |
</div>

  <div id="_mcePaste">
  +&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-+
</div>

  <div id="_mcePaste">
  | character_set_client     | utf8                                   |
</div>

  <div id="_mcePaste">
  | character_set_connection | utf8                                   |
</div>

  <div id="_mcePaste">
  | character_set_database   | utf8                                   |
</div>

  <div id="_mcePaste">
  | character_set_filesystem | binary                                 |
</div>

  <div id="_mcePaste">
  | character_set_results    | utf8                                   |
</div>

  <div id="_mcePaste">
  | character_set_server     | utf8                                   |
</div>

  <div id="_mcePaste">
  | character_set_system     | utf8                                   |
</div>

  <div id="_mcePaste">
  | character_sets_dir       | C:\eclipse\xampp\mysql\share\charsets\ |
</div>

  <div id="_mcePaste">
  +&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-+
</div>

  <div id="_mcePaste">
  8 rows in set (0.00 sec)
</div>
</blockquote>

<div id="_mcePaste">
  どれかがlatin1などのままならば設定が不十分なので、もう一度my.iniを確認すること。
</div>

<hr />

<p><strong>海外の役立つブログ記事などを人力で翻訳して公開する<a href="https://yakst.com/ja">Yakst</a>というプロジェクトをやっています。よろしければそちらもどうぞ！</strong></p>

</article>


<aside class="related">
  <h3>Related posts</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/aws/periodic-ebs-snapshot/">
          AWSのEBSボリュームのスナップショットを定期的に取る
          <small><time datetime="2015-10-19T06:33:30-07:00">19 Oct 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/misc/my-twitter-bots/">
          Twitterボットを作るのがひそかな趣味
          <small><time datetime="2015-05-22T06:26:26-07:00">22 May 2015</time></small>
        </a>
      </li>
    
      <li>
        <a href="/uncategorized/sql-performance-explained-ja/">
          「SQLパフォーマンス詳解」という本を翻訳しました
          <small><time datetime="2015-04-07T01:45:15-07:00">07 Apr 2015</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2016-04-01T11:15:44-07:00">2016</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
